<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sofanit - Professional Study App</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #e6f2ff 0%, #cce7ff 50%, #b3d9ff 100%);
    min-height: 100vh;
    overflow-x: hidden;
    padding: 20px;
    position: relative;
    width: 100%;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: none;
  }

  @supports (-webkit-touch-callout: none) {
    body {
      min-height: -webkit-fill-available;
    }
  }

  /* Prevent body scrolling when modals are open */
  body.modal-open {
    overflow: hidden;
  }

  /* Fix for fast blinking/zoom issue */
  @media (max-width: 768px) {
    body {
      touch-action: pan-x pan-y;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      font-size: 16px !important; /* Prevents iOS zoom on focus */
    }
  }

  /* Main container */
  .main-container {
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }

  .card-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }

  .card {
    display: flex;
    flex-direction: column;
    position: relative;
    width: 100%;
    max-width: 500px;
    min-height: 680px;
    height: auto;
    max-height: 90vh;
    border-radius: 24px;
    overflow: hidden;
    background: linear-gradient(145deg, #ffffff, #f0f9ff);
    box-shadow: 0 15px 35px rgba(0, 119, 255, 0.15),
                0 5px 15px rgba(0, 119, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
    border: 2px solid rgba(0, 150, 255, 0.15);
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 119, 255, 0.25),
                0 10px 20px rgba(0, 119, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
  }
  
  .card-header {
    position: relative;
    width: 100%;
    height: 110px;
    min-height: 110px;
    overflow: hidden;
    background: linear-gradient(135deg, #0077ff 0%, #00a2ff 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
    font-size: 1.4rem;
    font-weight: 700;
    padding: 15px;
    flex-shrink: 0;
    border-bottom: 3px solid rgba(255, 255, 255, 0.3);
  }

  .card-content {
    padding: 20px 25px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.7);
  }

  /* ACCORDION STYLES */
  .accordion-item {
    margin-bottom: 8px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(0, 150, 255, 0.2);
    background: white;
  }

  .accordion-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #0077ff 0%, #00a2ff 100%);
    color: white;
    font-weight: bold;
    font-size: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }

  .accordion-header:hover {
    background: linear-gradient(135deg, #0066dd 0%, #0091e6 100%);
  }

  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background: linear-gradient(to bottom, #f8fbff, #f0f9ff);
  }

  .accordion-content.expanded {
    max-height: 300px;
  }

  /* SMALL SCROLLBAR for accordion resources */
  .accordion-resources-container {
    max-height: 180px;
    overflow-y: auto;
    padding: 10px;
    padding-right: 5px;
  }

  /* Resource item styles for accordion */
  .accordion-resource-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0, 150, 255, 0.1);
    font-size: 0.8rem;
    position: relative;
    border-radius: 8px;
    margin-bottom: 4px;
    transition: all 0.2s ease;
    background: white;
  }

  .accordion-resource-item:hover {
    background: rgba(0, 150, 255, 0.05);
    transform: translateX(5px);
  }

  .accordion-resource-item:last-child {
    border-bottom: none;
  }

  /* BIG SCROLLBAR for all levels */
  #levelsScrollContainer {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
    background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
    border-radius: 12px;
    border: 1px solid rgba(156, 163, 175, 0.3);
  }

  .modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 50, 100, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
    backdrop-filter: blur(5px);
  }
  
  .modal-content {
    background: linear-gradient(145deg, #ffffff, #f5fbff);
    border-radius: 20px;
    padding: 25px;
    width: 95%;
    max-width: 550px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0, 100, 200, 0.3);
    display: flex;
    flex-direction: column;
    border: 1px solid rgba(0, 150, 255, 0.2);
    animation: modalAppear 0.3s ease-out;
  }

  @keyframes modalAppear {
    0% { transform: scale(0.95); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  
  /* Custom Scrollbar Styles */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: rgba(0, 119, 255, 0.1);
    border-radius: 10px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #0077ff, #00a2ff);
    border-radius: 10px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #0066dd, #0091e6);
  }

  /* Big scrollbar specific */
  #levelsScrollContainer::-webkit-scrollbar {
    width: 12px;
  }

  #levelsScrollContainer::-webkit-scrollbar-track {
    background: rgba(100, 100, 100, 0.1);
    border-radius: 10px;
  }

  #levelsScrollContainer::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #666, #999);
    border-radius: 10px;
  }

  #levelsScrollContainer::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #555, #888);
  }

  /* Small scrollbar specific */
  .accordion-resources-container::-webkit-scrollbar {
    width: 8px;
  }

  .accordion-resources-container::-webkit-scrollbar-track {
    background: rgba(100, 100, 100, 0.1);
    border-radius: 8px;
  }

  .accordion-resources-container::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #888, #aaa);
    border-radius: 8px;
  }

  .accordion-resources-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #777, #999);
  }

  /* Expandable Modal */
  .modal-expanded {
    width: 95% !important;
    max-width: 800px !important;
    height: 90vh !important;
  }

  .expand-button {
    position: absolute;
    top: 15px;
    right: 50px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
  }

  .expand-button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 10px;
    margin-bottom: 15px;
  }

  /* Level three dots menu - MOVED TO BOTTOM */
  .level-three-dots {
    position: absolute;
    right: 8px;
    bottom: 8px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 150, 255, 0.3);
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s ease;
    font-size: 12px;
    font-weight: bold;
  }
  
  .level-three-dots:hover {
    background: white;
    box-shadow: 0 3px 8px rgba(0, 119, 255, 0.2);
    transform: scale(1.1);
  }

  /* GRAY LEVEL BUTTONS */
  .level-btn {
    position: relative;
    border: 2px solid rgba(156, 163, 175, 0.3);
    border-radius: 12px;
    padding: 12px 8px;
    height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #f9fafb, #f3f4f6);
    overflow: hidden;
    cursor: pointer;
    color: #374151;
  }

  .level-btn:hover {
    transform: translateY(-3px);
    border-color: rgba(107, 114, 128, 0.5);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
  }

  .level-btn.gray-hover:hover {
    background: linear-gradient(to bottom, #e5e7eb, #d1d5db) !important;
    border-color: #9ca3af !important;
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }

  .level-btn.gray-hover:active {
    transform: translateY(-1px);
  }

  .question-item {
    background: linear-gradient(to right, #f7fbff, #eef7ff);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid rgba(0, 150, 255, 0.2);
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 119, 255, 0.1);
  }

  .question-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 119, 255, 0.15);
    border-color: rgba(0, 150, 255, 0.3);
  }
  
  .dashboard-stat-card {
    transition: all 0.3s ease;
    cursor: pointer;
    background: linear-gradient(135deg, #e6f2ff, #d6e9ff);
    border: 1px solid rgba(0, 150, 255, 0.2);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
  }
  
  .dashboard-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #0077ff, #00a2ff);
  }

  .dashboard-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 119, 255, 0.2);
  }

  .dashboard-stat-card:active {
    transform: scale(0.98);
  }
  
  .resource-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0, 150, 255, 0.1);
    font-size: 0.8rem;
    position: relative;
    border-radius: 8px;
    margin-bottom: 4px;
    transition: all 0.2s ease;
  }

  .resource-item:hover {
    background: rgba(0, 150, 255, 0.05);
    transform: translateX(5px);
  }

  .resource-item:last-child {
    border-bottom: none;
  }
  
  /* GLOBAL Resource Menu */
  #globalResourceMenu {
    position: fixed; 
    background: linear-gradient(135deg, #ffffff, #f5fbff);
    border: 1px solid rgba(0, 150, 255, 0.2);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 100, 200, 0.25);
    z-index: 99999; 
    display: none;
    width: 150px;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }

  #globalResourceMenu button {
    display: flex;
    align-items: center;
    width: 100%;
    text-align: left;
    padding: 12px 15px;
    font-size: 14px;
    color: #2c5282;
    border-bottom: 1px solid rgba(0, 150, 255, 0.1);
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #globalResourceMenu button:last-child {
    border-bottom: none;
  }

  #globalResourceMenu button:hover {
    background: linear-gradient(90deg, rgba(0, 150, 255, 0.1), rgba(0, 150, 255, 0.05));
    padding-left: 20px;
    color: #0077ff;
  }

  #globalResourceMenu button i {
    width: 20px;
    text-align: center;
    margin-right: 10px;
    color: #0077ff;
  }

  .subject-management-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: linear-gradient(to right, #f7fbff, #eef7ff);
    border: 1px solid rgba(0, 150, 255, 0.2);
    border-radius: 12px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }
  
  .subject-management-item:hover {
    background: linear-gradient(to right, #eef7ff, #e6f2ff);
    border-color: rgba(0, 150, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 119, 255, 0.1);
  }
  
  /* Three dots menu styling */
  .three-dots-menu {
    position: absolute;
    right: 10px;
    top: 10px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 150, 255, 0.3);
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s ease;
  }
  
  .three-dots-menu:hover {
    background: white;
    box-shadow: 0 3px 8px rgba(0, 119, 255, 0.2);
    transform: scale(1.1);
  }
  
  .option-three-dots {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 150, 255, 0.3);
    border-radius: 4px;
    padding: 3px 7px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .option-three-dots:hover {
    background: white;
    box-shadow: 0 2px 6px rgba(0, 119, 255, 0.2);
  }
  
  /* URL button styling */
  .url-button {
    background: linear-gradient(135deg, #ffb347, #ffcc33) !important;
    border: 1px solid rgba(255, 179, 71, 0.3) !important;
    color: white !important;
    box-shadow: 0 4px 6px rgba(255, 179, 71, 0.2);
  }
  
  .url-button:hover {
    background: linear-gradient(135deg, #ffa226, #ffc107) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(255, 179, 71, 0.3);
  }
  
  .url-input-container {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .url-input-container input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid rgba(0, 150, 255, 0.3);
    border-radius: 8px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.9);
    transition: all 0.3s ease;
  }

  .url-input-container input:focus {
    outline: none;
    border-color: #0077ff;
    box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
  }
  
  .add-more-url {
    background: linear-gradient(135deg, #00d2b5, #00c9a7);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(0, 210, 181, 0.2);
  }
  
  .add-more-url:hover {
    background: linear-gradient(135deg, #00c1a6, #00b896);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 210, 181, 0.3);
  }

  /* Button styles */
  .btn-primary {
    background: linear-gradient(135deg, #0077ff, #00a2ff);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 12px rgba(0, 119, 255, 0.2);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #0066dd, #0091e6);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 119, 255, 0.3);
  }

  .btn-primary:active {
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #6c757d, #868e96);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 12px rgba(108, 117, 125, 0.2);
  }

  .btn-secondary:hover {
    background: linear-gradient(135deg, #5a6268, #727b84);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
  }

  .btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 12px rgba(40, 167, 69, 0.2);
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #218838, #1ba87e);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
  }

  .btn-danger {
    background: linear-gradient(135deg, #dc3545, #ff6b6b);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 12px rgba(220, 53, 69, 0.2);
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #c82333, #ff5252);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
  }

  .btn-purple {
    background: linear-gradient(135deg, #6f42c1, #9c6eff);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 12px rgba(111, 66, 193, 0.2);
  }

  .btn-purple:hover {
    background: linear-gradient(135deg, #5e35b1, #8a5bff);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(111, 66, 193, 0.3);
  }

  /* Input styles */
  .input-field {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid rgba(0, 150, 255, 0.2);
    border-radius: 12px;
    font-size: 16px;
    background: rgba(255, 255, 255, 0.9);
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 119, 255, 0.05);
  }

  .input-field:focus {
    outline: none;
    border-color: #0077ff;
    box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1), 0 4px 6px rgba(0, 119, 255, 0.1);
    background: white;
  }

  /* Modal header and footer fixed */
  .modal-header {
    flex-shrink: 0;
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    padding-bottom: 15px;
  }

  .modal-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 3px;
    background: linear-gradient(90deg, #0077ff, #00a2ff);
    border-radius: 2px;
  }

  .modal-footer {
    flex-shrink: 0;
    margin-top: 20px;
  }

  /* Resource Uploader specific */
  .resource-section {
    background: linear-gradient(to right, #f7fbff, #eef7ff);
    border: 2px dashed rgba(0, 150, 255, 0.3);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
  }

  .resource-section:hover {
    border-color: rgba(0, 150, 255, 0.5);
    background: linear-gradient(to right, #eef7ff, #e6f2ff);
  }

  .resource-section label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #2c5282;
    font-size: 14px;
  }

  /* Ensure consistent sizing for form elements */
  .consistent-input {
    width: 100%;
    box-sizing: border-box;
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 150, 255, 0.3);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.9);
  }

  .consistent-input:focus {
    outline: none;
    border-color: #0077ff;
    box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1);
    background: white;
  }

  /* Quiz options */
  .quiz-option {
    background: linear-gradient(to right, #f0f8ff, #e6f2ff);
    border: 2px solid rgba(0, 150, 255, 0.2);
    border-radius: 12px;
    padding: 14px 20px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
    text-align: left;
    font-weight: 500;
  }

  .quiz-option:hover {
    background: linear-gradient(to right, #e6f2ff, #d6e9ff);
    border-color: rgba(0, 150, 255, 0.4);
    transform: translateX(5px);
  }

  /* Subject buttons */
  .subject-btn {
    background: linear-gradient(135deg, #4dabff, #0077ff);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 20px 15px;
    font-weight: 700;
    font-size: 1.1rem;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 10px 20px rgba(0, 119, 255, 0.2);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .subject-btn:hover {
    transform: translateY(-8px) scale(1.05);
    box-shadow: 0 20px 40px rgba(0, 119, 255, 0.3);
  }

  .subject-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.7s;
  }

  .subject-btn:hover::before {
    left: 100%;
  }

  /* Level rename modal - UPDATED FOR CHAPTER NAMES */
  .level-rename-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }

  .level-rename-content {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 90%;
    max-width: 400px;
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .card {
      max-width: 95%;
      min-height: 650px;
    }
    
    .grid-cols-5 {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    .card {
      max-width: 100%;
      min-height: 600px;
      border-radius: 20px;
    }
    
    .card-header {
      height: 100px;
      min-height: 100px;
      font-size: 1.2rem;
      padding: 12px;
    }
    
    .card-content {
      padding: 15px 20px;
    }
    
    .modal-content {
      padding: 20px;
      width: 95%;
      max-height: 85vh;
    }
    
    .modal-expanded {
      width: 95% !important;
      max-width: 95% !important;
      height: 85vh !important;
    }
    
    .level-btn {
      height: 65px;
      padding: 10px 8px;
    }
    
    .grid-cols-5 {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .grid-cols-2 {
      grid-template-columns: 1fr;
    }
    
    .subject-btn {
      padding: 16px 12px;
      font-size: 1rem;
    }
    
    /* Adjust scrollbar heights for mobile */
    #levelsScrollContainer {
      max-height: 250px;
    }
    
    .accordion-resources-container {
      max-height: 150px;
    }
    
    .accordion-content.expanded {
      max-height: 250px;
    }
  }

  @media (max-width: 640px) {
    body {
      padding: 10px;
    }
    
    .card {
      min-height: 580px;
      border-radius: 18px;
    }
    
    .card-header {
      height: 90px;
      min-height: 90px;
      font-size: 1.1rem;
    }
    
    .card-content {
      padding: 12px 15px;
    }
    
    .grid-cols-5 {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .grid-cols-2 {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .modal-content {
      padding: 15px;
      width: 98%;
      border-radius: 16px;
    }
    
    .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-purple {
      padding: 10px 18px;
      font-size: 14px;
    }
    
    .input-field {
      padding: 12px 14px;
      font-size: 15px;
    }
    
    .accordion-header {
      padding: 12px 15px;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    body {
      padding: 8px;
    }
    
    .card {
      min-height: 550px;
      border-radius: 16px;
    }
    
    .card-header {
      height: 85px;
      min-height: 85px;
      font-size: 1rem;
      padding: 10px;
    }
    
    .card-content {
      padding: 10px 12px;
    }
    
    .grid-cols-5 {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .subject-btn {
      padding: 14px 10px;
      font-size: 0.95rem;
    }
    
    .modal-content {
      padding: 12px;
      border-radius: 14px;
    }
    
    .modal-expanded {
      width: 98% !important;
      height: 90vh !important;
    }
    
    .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-purple {
      padding: 9px 15px;
      font-size: 13px;
    }
    
    .input-field {
      padding: 11px 13px;
      font-size: 14px;
    }
    
    .accordion-content.expanded {
      max-height: 200px;
    }
    
    #levelsScrollContainer {
      max-height: 200px;
    }
    
    .accordion-resources-container {
      max-height: 120px;
    }
  }

  @media (max-width: 360px) {
    .grid-cols-5 {
      grid-template-columns: 1fr;
    }
    
    .grid-cols-2 {
      grid-template-columns: 1fr;
    }
    
    .subject-btn {
      padding: 12px 8px;
      font-size: 0.9rem;
    }
    
    .level-btn {
      height: 60px;
      padding: 8px 6px;
    }
  }
</style>
</head>
<body>

  <div class="main-container">
    <!-- GLOBAL MENU CONTAINER -->
    <div id="globalResourceMenu"></div>

    <!-- Level Rename Modal - UPDATED FOR CHAPTER NAMES -->
    <div id="levelRenameModal" class="level-rename-modal">
      <div class="level-rename-content">
        <h4 class="modal-header text-xl font-bold text-gray-800 mb-4">Rename Level</h4>
        <div class="mb-4">
          <p class="text-sm text-gray-600 mb-2">Rename level to Chapter name:</p>
          <input type="text" id="newChapterName" class="input-field mb-2" placeholder="e.g., Chapter 1, Chapter 2, etc.">
          <p class="text-xs text-gray-500">Or enter level number (1-20):</p>
          <input type="number" id="newLevelNumber" min="1" max="20" class="input-field" placeholder="New Level Number">
        </div>
        <div class="flex justify-between space-x-3">
          <button type="button" onclick="closeLevelRenameModal()" class="btn-secondary w-full py-3">Cancel</button>
          <button type="button" onclick="saveLevelRename()" class="btn-success w-full py-3">Rename</button>
        </div>
      </div>
    </div>

    <div class="card-container">
      <div class="card" id="quizCard">
        <div class="card-header">
          <div id="quizTimerDisplay" class="text-base font-bold text-white bg-gradient-to-r from-green-400 to-blue-400 px-4 py-2 rounded-full shadow-lg hidden mb-2">
            01:00
          </div>
          <!-- CHANGED: "Welcome! Sign In" to "AWA - Study - Vault !" -->
          <div id="headerTitle" class="text-2xl font-extrabold tracking-wide text-center">AWA - Study - Vault !</div>
        </div>

        <div class="card-content" id="quizApp"></div>
        
        <!-- Password Modal -->
        <div id="passwordModal" class="modal-bg">
          <div class="modal-content transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <h4 id="modalTitle" class="modal-header text-xl font-bold text-gray-800">Admin Access</h4>
            <input type="password" id="passwordInput" class="input-field mb-4 text-center" placeholder="Enter admin123">
            <div class="flex justify-center space-x-3">
              <button type="button" onclick="closeModal()" class="btn-secondary px-6 py-3">Cancel</button>
              <button type="button" onclick="checkAdminPassword()" class="btn-primary px-6 py-3">Enter</button>
            </div>
            <p id="passwordError" class="text-red-500 text-sm mt-3 hidden text-center">Incorrect password.</p>
          </div>
        </div>
        
        <!-- Reset Quiz Modal -->
        <div id="resetQuizModal" class="modal-bg">
          <div class="modal-content transform transition-all duration-300 scale-95 opacity-0" id="resetModalContent">
            <h4 id="resetModalTitle" class="modal-header text-xl font-bold text-gray-800">Reset Quiz Progress</h4>
            <div class="mb-6">
              <p class="text-sm text-gray-600 mb-3">This will reset ALL quiz progress for ALL users. This action cannot be undone.</p>
              <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 p-4 rounded-xl">
                <p class="text-sm font-bold text-red-600 mb-2">Warning:</p>
                <p class="text-xs text-red-500">All user progress, scores, and quiz attempts will be deleted.</p>
              </div>
            </div>
            <input type="password" id="resetPasswordInput" class="input-field mb-4 text-center" placeholder="Enter admin password">
            <div class="flex justify-center space-x-3">
              <button type="button" onclick="closeResetModal()" class="btn-secondary px-6 py-3">Cancel</button>
              <button type="button" onclick="confirmResetQuizProgress()" class="btn-danger px-6 py-3">Reset All Progress</button>
            </div>
            <p id="resetPasswordError" class="text-red-500 text-sm mt-3 hidden text-center">Incorrect password.</p>
          </div>
        </div>
        
        <!-- Subject Management Modal -->
        <div id="subjectManagementModal" class="modal-bg">
          <div class="modal-content">
            <button class="expand-button" onclick="toggleModalExpand('subjectManagementModal')">
              <i class="fas fa-expand"></i>
            </button>
            <h4 class="modal-header text-xl font-bold text-gray-800">Subject Management</h4>
            
            <div class="modal-body">
              <div class="mb-6">
                <div class="flex items-center mb-4">
                  <input type="text" id="newSubjectName" placeholder="Enter new subject name" 
                         class="flex-grow p-3 border rounded-l-xl text-sm input-field" maxlength="50">
                  <button type="button" onclick="addNewSubject()" 
                          class="btn-success p-3 rounded-r-xl text-sm">
                    <i class="fas fa-plus mr-2"></i> Add
                  </button>
                </div>
                
                <div id="subjectListContainer" class="space-y-3 max-h-60 overflow-y-auto p-3 bg-gradient-to-b from-blue-50 to-transparent rounded-xl border border-blue-100">
                  <!-- Subject items will be dynamically inserted here -->
                </div>
                
                <div class="mt-4 text-xs text-blue-600 bg-blue-50 p-3 rounded-lg">
                  <p><i class="fas fa-info-circle mr-2"></i> Subjects with content cannot be deleted until all questions and resources are removed.</p>
                </div>
              </div>
            </div>
            
            <div class="modal-footer flex justify-between space-x-3">
              <button type="button" onclick="closeSubjectManagement()" class="btn-secondary w-full py-3">Close</button>
              <button type="button" onclick="saveSubjectChanges()" class="btn-primary w-full py-3">Save Changes</button>
            </div>
          </div>
        </div>
        
        <!-- Bulk Uploader Modal -->
        <div id="bulkUploaderModal" class="modal-bg">
          <div class="modal-content">
            <button class="expand-button" onclick="toggleModalExpand('bulkUploaderModal')">
              <i class="fas fa-expand"></i>
            </button>
            <h4 class="modal-header text-xl font-bold text-gray-800">Bulk Question Uploader</h4>
            
            <div class="modal-body">
              <div class="mb-4 text-sm text-blue-600 bg-blue-50 p-3 rounded-lg">
                <p class="mb-2 font-semibold">CSV Format: subject,level,question,options,answer,type,hint</p>
                <p class="mb-2">Options separated by "|". Example: <span class="font-mono bg-white p-1 rounded border">Math,1,2+2?,3|4|5,4,radio,Easy</span></p>
                <input type="file" id="csvFileInput" accept=".csv" class="w-full p-2 border rounded-lg mb-3 input-field">
                <p class="mb-2 font-semibold">OR JSON:</p>
                <input type="file" id="jsonFileInput" accept=".json" class="w-full p-2 border rounded-lg input-field">
              </div>
              
              <div class="grid grid-cols-2 gap-3 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Subject</label>
                    <div class="flex">
                      <select id="uploadSubject" class="flex-grow p-3 text-sm border rounded-l-xl consistent-input">
                        <!-- Subjects will be populated dynamically -->
                      </select>
                      <button type="button" onclick="openSubjectManagementFromUploader()" 
                              class="btn-secondary p-3 rounded-r-xl text-xs" title="Manage Subjects">
                        <i class="fas fa-cog"></i>
                      </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Level</label>
                    <select id="uploadLevel" class="w-full p-3 text-sm border rounded-xl consistent-input">
                      <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                      <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                    </select>
                </div>
              </div>
            </div>
            
            <div class="modal-footer flex justify-between space-x-3">
              <button type="button" onclick="closeBulkUploader()" class="btn-secondary w-full py-3">Cancel</button>
              <button type="button" onclick="processBulkUpload()" class="btn-success w-full py-3">Upload</button>
            </div>
          </div>
        </div>
        
        <!-- Manual Exam Creator Modal -->
        <div id="manualExamModal" class="modal-bg">
          <div class="modal-content">
            <button class="expand-button" onclick="toggleModalExpand('manualExamModal')">
              <i class="fas fa-expand"></i>
            </button>
            <h4 class="modal-header text-xl font-bold text-gray-800">Manual Exam Creator</h4>
            
            <div class="modal-body">
              <div class="mb-4">
                <div class="grid grid-cols-2 gap-3 mb-4">
                  <div class="flex">
                    <select id="manualSubject" class="flex-grow p-3 text-sm border rounded-l-xl consistent-input">
                      <!-- Subjects will be populated dynamically -->
                    </select>
                    <button type="button" onclick="openSubjectManagementFromManual()" 
                            class="btn-secondary p-3 rounded-r-xl text-xs" title="Manage Subjects">
                      <i class="fas fa-cog"></i>
                    </button>
                  </div>
                  <select id="manualLevel" class="w-full p-3 text-sm border rounded-xl consistent-input">
                      <option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option>
                      <option value="6">Level 6</option><option value="7">Level 7</option><option value="8">Level 8</option><option value="9">Level 9</option><option value="10">Level 10</option>
                  </select>
                </div>
                
                <div id="manualQuestionsContainer" class="space-y-4 overflow-y-auto pr-2"></div>
                
                <button type="button" onclick="addManualQuestion()" class="w-full mt-3 bg-gradient-to-r from-blue-100 to-blue-50 hover:from-blue-200 hover:to-blue-100 text-blue-700 font-bold py-3 rounded-xl text-sm flex items-center justify-center border border-blue-300 transition-all duration-300">
                  <i class="fas fa-plus-circle mr-2 text-lg"></i> Add New Question
                </button>
              </div>
            </div>
            
            <div class="modal-footer flex justify-between space-x-3">
              <button type="button" onclick="closeManualExamCreator()" class="btn-secondary w-full py-3">Cancel</button>
              <button type="button" onclick="saveManualExam()" class="btn-success w-full py-3">Save Exam</button>
            </div>
          </div>
        </div>
        
        <!-- Resource Uploader Modal -->
        <div id="resourceUploaderModal" class="modal-bg">
          <div class="modal-content">
            <button class="expand-button" onclick="toggleModalExpand('resourceUploaderModal')">
              <i class="fas fa-expand"></i>
            </button>
            <h4 class="modal-header text-xl font-bold text-gray-800">Resource Uploader</h4>
            
            <div class="modal-body">
              <div class="mb-4">
                <div class="grid grid-cols-2 gap-3 mb-6">
                  <div class="flex">
                    <select id="resourceSubject" class="flex-grow p-3 text-sm border rounded-l-xl consistent-input">
                      <!-- Subjects will be populated dynamically -->
                    </select>
                    <button type="button" onclick="openSubjectManagementFromResource()" 
                            class="btn-secondary p-3 rounded-r-xl text-xs" title="Manage Subjects">
                      <i class="fas fa-cog"></i>
                    </button>
                  </div>
                  <select id="resourceLevel" class="w-full p-3 text-sm border rounded-xl consistent-input">
                      <option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option>
                      <option value="6">Level 6</option><option value="7">Level 7</option><option value="8">Level 8</option><option value="9">Level 9</option><option value="10">Level 10</option>
                  </select>
                </div>
                
                <div class="resource-section">
                  <label class="block text-sm font-bold text-gray-700 mb-3"><i class="fas fa-file-pdf mr-2 text-red-500"></i> Add Document (PDF/HTML/ZIP)</label>
                  <input type="file" id="pdfFileInput" accept=".pdf,.zip,.html,.htm" class="w-full p-3 text-sm input-field">
                </div>
                
                <div class="resource-section">
                  <label class="block text-sm font-bold text-gray-700 mb-3"><i class="fas fa-video mr-2 text-blue-500"></i> Add Video</label>
                  <input type="file" id="videoFileInput" accept="video/*" class="w-full p-3 text-sm input-field">
                </div>
                
                <!-- URL Management Section -->
                <div class="resource-section">
                  <label class="block text-sm font-bold text-gray-700 mb-3"><i class="fas fa-link mr-2 text-purple-500"></i> Add URL Links</label>
                  <div id="urlInputsContainer">
                    <div class="url-input-container">
                      <input type="text" placeholder="URL Name" class="url-name-input consistent-input" value="">
                      <input type="url" placeholder="https://example.com" class="url-link-input consistent-input" value="">
                      <button type="button" class="add-more-url" onclick="addMoreUrlInput()">+</button>
                    </div>
                  </div>
                </div>
                
                <div id="resourceUploadStatus" class="text-sm text-blue-600 text-center hidden font-bold mt-3 p-3 bg-blue-50 rounded-lg">Uploading... Please wait</div>
              </div>
            </div>
            
            <div class="modal-footer flex justify-between space-x-3">
              <button type="button" onclick="closeResourceUploader()" class="btn-secondary w-full py-3">Close</button>
              <button type="button" onclick="saveResources()" class="btn-purple w-full py-3">Upload & Save</button>
            </div>
          </div>
        </div>
        
        <!-- Admin Dashboard Footer Button -->
        <div id="adminFooter" class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-200 mt-auto">
          <div class="flex space-x-3 mb-3">
            <button type="button" onclick="handleSignOut()" class="btn-secondary w-full py-3 rounded-xl shadow-lg transition-all duration-300 text-sm flex items-center justify-center">
              <i class="fas fa-sign-out-alt mr-3 text-lg"></i>
              Sign Out
            </button>
          </div>
          <button type="button" onclick="openModal('dashboard')" class="w-full btn-danger py-3 px-6 rounded-xl shadow-lg transition-all duration-300 text-sm flex items-center justify-center">
            <i class="fas fa-cogs mr-3 text-lg"></i>
            Admin Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==== PREVENT BLINKING FIXES ====
    // Enhanced prevention for mobile zoom and blinking
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // Prevent double-tap zoom
    document.addEventListener('dblclick', function(e) {
      e.preventDefault();
    }, { passive: false });

    // Force stable viewport on mobile
    function setViewportProperties() {
      const viewport = document.querySelector('meta[name="viewport"]');
      if (window.innerWidth <= 768) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no');
      } else {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
      }
    }

    // Call on load and resize
    window.addEventListener('load', function() {
      setViewportProperties();
      // Prevent resize issues
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(setViewportProperties, 250);
      });
    });

    // ==== ACCORDION FUNCTIONS ====
    function toggleAccordion(level) {
      const content = document.getElementById(`accordion-content-${level}`);
      const icon = document.getElementById(`accordion-icon-${level}`);
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.className = 'fas fa-chevron-down';
      } else {
        // Close all other accordions
        document.querySelectorAll('.accordion-content').forEach(acc => {
          acc.classList.remove('expanded');
        });
        document.querySelectorAll('.accordion-header i').forEach(icon => {
          icon.className = 'fas fa-chevron-down';
        });
        
        // Open this one
        content.classList.add('expanded');
        icon.className = 'fas fa-chevron-up';
      }
    }

    // ==== INDEXEDDB HELPERS ====
    const DB_NAME = 'SofanitDB';
    const DB_VERSION = 2;
    const STORE_NAME = 'resources';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    async function saveFileToDB(fileBlob, id) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put({ id: id, file: fileBlob });
            request.onsuccess = () => resolve();
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async function getFileFromDB(id) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = (event) => {
                const result = event.target.result;
                resolve(result ? result.file : null);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    // ==== GLOBAL VARIABLES ====
    let quizApp, headerTitle, timerDisplay;
    let isAuthenticated = false;
    let currentUser = null;
    let mockUsers = [];
    const adminPassword = "admin123";
    
    // Storage keys
    const STORAGE_KEY = 'sofanit_users';
    const SETTINGS_KEY = 'sofanit_settings';
    const QUIZ_DATA_KEY = 'sofanit_quiz_data';
    const RESOURCES_KEY = 'sofanit_resources_v3';
    const SUBJECTS_KEY = 'sofanit_subjects';
    
    // Quiz state
    let currentSubject = '';
    let currentLevel = 0;
    let currentQuestionIndex = 0;
    let score = 0;
    let startTime = null;
    let isAnswered = false;
    let selectedOptions = []; 
    let quizSettings = {
        timerEnabled: true,
        minutesPerQuestion: 1
    };
    
    // Quiz data structure
    let quizData = {};
    let resources = {};
    let manualQuestions = [];
    let subjects = [];
    let pendingSubjectChanges = [];
    
    // Level display names (for Chapter 1, Chapter 2, etc.)
    let levelDisplayNames = {};
    
    // URL management
    let urlInputs = [{
        name: '',
        url: ''
    }];

    // Level rename state
    let levelRenameState = {
        subject: '',
        oldLevel: 0,
        newLevel: 0
    };

    // Default subjects
    const DEFAULT_SUBJECTS = ["Math", "Reading", "Science", "Computer Science"];

    // Helper: Normalize text
    function normalizeText(text) {
        if (text === null || text === undefined) return "";
        return String(text)
            .toLowerCase()
            .trim()
            .replace(/\s+/g, ' ')
            .replace(/[^\w\s]/g, '')
            .replace(/\s+/g, ' ');
    }

    // ==== INITIALIZATION ====
    document.addEventListener('DOMContentLoaded', function() {
        quizApp = document.getElementById('quizApp');
        headerTitle = document.getElementById('headerTitle');
        timerDisplay = document.getElementById('quizTimerDisplay');
        
        loadUsers();
        loadSettings();
        loadSubjects();
        loadQuizData();
        loadResources();
        loadLevelDisplayNames();
        
        if (!mockUsers.some(user => user.username === 'admin')) {
            mockUsers.push({
                username: "admin",
                password: adminPassword,
                name: "Admin User",
                email: "admin@sofanit.com",
                grade: "N/A",
                quizzesTaken: 0,
                lastAttempt: null,
                levelProgress: {},
                lastAttemptDetails: {}, 
                testHistory: [],
                role: "admin"
            });
            saveUsers();
        }
        
        // Message listener for HTML exams
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'QUIZ_RESULT') {
                const { score: rScore, total: rTotal, subject: rSub, level: rLvl, userId } = event.data;
                
                let targetUser = currentUser;
                if (userId) {
                    const foundUser = mockUsers.find(u => u.email === userId || u.username === userId);
                    if (foundUser) targetUser = foundUser;
                }
                
                if (!targetUser) return;
                
                const uIdx = mockUsers.findIndex(u => u.email === targetUser.email);
                
                const finalSub = rSub || currentSubject || "External";
                const finalLvl = parseInt(rLvl) || currentLevel || 1;
                const score = parseInt(rScore) || 0;
                const total = parseInt(rTotal) || 1;

                if (uIdx !== -1) {
                    const pct = Math.round((score / total) * 100);
                    mockUsers[uIdx].quizzesTaken++;
                    
                    if (!mockUsers[uIdx].levelProgress[finalSub]) {
                        mockUsers[uIdx].levelProgress[finalSub] = {};
                    }
                    
                    const currentProgress = mockUsers[uIdx].levelProgress[finalSub][finalLvl] || 0;
                    mockUsers[uIdx].levelProgress[finalSub][finalLvl] = Math.max(currentProgress, pct);
                    
                    const newAttempt = {
                        subject: finalSub,
                        level: finalLvl,
                        score: pct,
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString(),
                        duration: "External HTML Quiz",
                        rawScore: `${score}/${total}`
                    };
                    
                    mockUsers[uIdx].lastAttemptDetails = newAttempt;
                    
                    if (!mockUsers[uIdx].testHistory) mockUsers[uIdx].testHistory = [];
                    mockUsers[uIdx].testHistory.unshift(newAttempt);
                    
                    saveUsers();
                    
                    alertMessage(`External Quiz Recorded: ${score}/${total} (${pct}%)`, "bg-gradient-to-r from-green-500 to-blue-500");
                    
                    if (currentSubject === finalSub) {
                        renderSubjectLevels(finalSub);
                    }
                    
                    if (headerTitle.textContent.includes("Admin Dashboard")) {
                        renderAdminDashboard();
                    }
                }
            }
        });
        
        renderAuthScreen();
        
        // Initialize URL inputs
        updateUrlInputs();
        
        // Update subject selects on load
        setTimeout(() => {
            updateSubjectSelects();
        }, 100);
    });

    // ==== LEVEL DISPLAY NAMES FUNCTIONS ====
    function loadLevelDisplayNames() {
        const saved = localStorage.getItem('sofanit_level_names');
        if (saved) {
            levelDisplayNames = JSON.parse(saved);
        } else {
            levelDisplayNames = {};
        }
    }
    
    function saveLevelDisplayNames() {
        localStorage.setItem('sofanit_level_names', JSON.stringify(levelDisplayNames));
    }
    
    function getLevelDisplayName(subject, level) {
        const key = `${subject}_${level}`;
        if (levelDisplayNames[key]) {
            return levelDisplayNames[key];
        }
        return `Lvl ${level}`;
    }
    
    function setLevelDisplayName(subject, level, name) {
        const key = `${subject}_${level}`;
        if (name && name.trim()) {
            levelDisplayNames[key] = name.trim();
        } else {
            delete levelDisplayNames[key];
        }
        saveLevelDisplayNames();
    }

    // ==== MODAL EXPAND FUNCTIONALITY ====
    function toggleModalExpand(modalId) {
        const modalContent = document.querySelector(`#${modalId} .modal-content`);
        modalContent.classList.toggle('modal-expanded');
        const expandBtn = document.querySelector(`#${modalId} .expand-button i`);
        if (modalContent.classList.contains('modal-expanded')) {
            expandBtn.className = 'fas fa-compress';
        } else {
            expandBtn.className = 'fas fa-expand';
        }
    }

    // ==== LEVEL RENAME FUNCTIONS - UPDATED FOR CHAPTER NAMES ====
    function openLevelRenameModal(subject, level) {
        levelRenameState.subject = subject;
        levelRenameState.oldLevel = level;
        
        // Get current display name
        const currentDisplayName = getLevelDisplayName(subject, level);
        const isChapterName = currentDisplayName.startsWith('Chapter ') || currentDisplayName.startsWith('Chap ');
        
        document.getElementById('newChapterName').value = isChapterName ? currentDisplayName : '';
        document.getElementById('newLevelNumber').value = level;
        document.getElementById('levelRenameModal').style.display = 'flex';
    }
    
    function closeLevelRenameModal() {
        document.getElementById('levelRenameModal').style.display = 'none';
        levelRenameState = {
            subject: '',
            oldLevel: 0,
            newLevel: 0
        };
    }
    
    function saveLevelRename() {
        const chapterName = document.getElementById('newChapterName').value.trim();
        const newLevel = parseInt(document.getElementById('newLevelNumber').value);
        
        const subject = levelRenameState.subject;
        const oldLevel = levelRenameState.oldLevel;
        
        // If chapter name is provided, use it
        if (chapterName) {
            setLevelDisplayName(subject, oldLevel, chapterName);
            saveLevelDisplayNames();
            
            closeLevelRenameModal();
            alertMessage(`Level ${oldLevel} renamed to "${chapterName}"`, "bg-gradient-to-r from-green-500 to-teal-500");
            
            renderSubjectLevels(subject);
            return;
        }
        
        // Otherwise, use level number
        if (!newLevel || newLevel < 1 || newLevel > 20) {
            alertMessage("Please enter a valid level number (1-20)", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        if (newLevel === oldLevel) {
            closeLevelRenameModal();
            return;
        }
        
        // Check if new level already exists
        if (quizData[subject] && quizData[subject][newLevel]) {
            if (!confirm(`Level ${newLevel} already exists. Overwrite it?`)) {
                return;
            }
        }
        
        // Move quiz data
        if (quizData[subject] && quizData[subject][oldLevel]) {
            if (!quizData[subject][newLevel]) quizData[subject][newLevel] = [];
            quizData[subject][newLevel] = [...quizData[subject][oldLevel]];
            delete quizData[subject][oldLevel];
            
            // Move display name if exists
            const oldKey = `${subject}_${oldLevel}`;
            const newKey = `${subject}_${newLevel}`;
            if (levelDisplayNames[oldKey]) {
                levelDisplayNames[newKey] = levelDisplayNames[oldKey];
                delete levelDisplayNames[oldKey];
                saveLevelDisplayNames();
            }
        }
        
        // Move resources
        if (resources[subject] && resources[subject][oldLevel]) {
            if (!resources[subject][newLevel]) resources[subject][newLevel] = { pdfs: [], videos: [], urls: [] };
            resources[subject][newLevel] = { ...resources[subject][oldLevel] };
            delete resources[subject][oldLevel];
        }
        
        // Update user progress
        mockUsers.forEach(user => {
            if (user.levelProgress && user.levelProgress[subject]) {
                if (user.levelProgress[subject][oldLevel] !== undefined) {
                    user.levelProgress[subject][newLevel] = user.levelProgress[subject][oldLevel];
                    delete user.levelProgress[subject][oldLevel];
                }
            }
            
            // Update test history
            if (user.testHistory) {
                user.testHistory.forEach(test => {
                    if (test.subject === subject && test.level === oldLevel) {
                        test.level = newLevel;
                    }
                });
            }
        });
        
        saveQuizData();
        saveResourcesMeta();
        saveUsers();
        
        closeLevelRenameModal();
        alertMessage(`Level ${oldLevel} renamed to Level ${newLevel}`, "bg-gradient-to-r from-green-500 to-teal-500");
        
        renderSubjectLevels(subject);
    }

    // ==== URL INPUT MANAGEMENT ====
    function updateUrlInputs() {
        const container = document.getElementById('urlInputsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        urlInputs.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'url-input-container';
            div.innerHTML = `
                <input type="text" placeholder="URL Name" class="url-name-input consistent-input" value="${url.name}" 
                       oninput="updateUrlInput(${index}, 'name', this.value)">
                <input type="url" placeholder="https://example.com" class="url-link-input consistent-input" value="${url.url}" 
                       oninput="updateUrlInput(${index}, 'url', this.value)">
                ${index === 0 ? 
                    '<button type="button" class="add-more-url" onclick="addMoreUrlInput()">+</button>' : 
                    '<button type="button" class="add-more-url" onclick="removeUrlInput(' + index + ')">-</button>'
                }
            `;
            container.appendChild(div);
        });
    }
    
    function updateUrlInput(index, field, value) {
        if (!urlInputs[index]) urlInputs[index] = { name: '', url: '' };
        urlInputs[index][field] = value;
    }
    
    function addMoreUrlInput() {
        urlInputs.push({ name: '', url: '' });
        updateUrlInputs();
    }
    
    function removeUrlInput(index) {
        if (urlInputs.length > 1) {
            urlInputs.splice(index, 1);
            updateUrlInputs();
        }
    }
    
    function resetUrlInputs() {
        urlInputs = [{ name: '', url: '' }];
        updateUrlInputs();
    }

    // ==== SUBJECT MANAGEMENT FUNCTIONS ====
    function loadSubjects() {
        const savedSubjects = localStorage.getItem(SUBJECTS_KEY);
        if (savedSubjects) {
            subjects = JSON.parse(savedSubjects);
        } else {
            subjects = [...DEFAULT_SUBJECTS];
            saveSubjects();
        }
    }
    
    function saveSubjects() {
        localStorage.setItem(SUBJECTS_KEY, JSON.stringify(subjects));
    }
    
    function updateSubjectSelects() {
        const subjectSelects = [
            'uploadSubject',
            'manualSubject',
            'resourceSubject'
        ];
        
        subjectSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = subjects.map(subject => 
                    `<option value="${subject}">${subject}</option>`
                ).join('');
            }
        });
    }
    
    function addNewSubject() {
        const newSubjectInput = document.getElementById('newSubjectName');
        const subjectName = newSubjectInput.value.trim();
        
        if (!subjectName) {
            alertMessage("Please enter a subject name", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        if (subjects.includes(subjectName)) {
            alertMessage(`Subject "${subjectName}" already exists`, "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        if (subjectName.length > 50) {
            alertMessage("Subject name too long (max 50 characters)", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        subjects.push(subjectName);
        saveSubjects();
        
        if (!quizData[subjectName]) {
            quizData[subjectName] = {};
        }
        if (!resources[subjectName]) {
            resources[subjectName] = {};
        }
        
        saveQuizData();
        saveResourcesMeta();
        
        renderSubjectManagementList();
        updateSubjectSelects();
        
        newSubjectInput.value = '';
        
        alertMessage(`Subject "${subjectName}" added successfully`, "bg-gradient-to-r from-green-500 to-teal-500");
    }
    
    function renameSubject(oldName, newName) {
        if (oldName === newName) return;
        
        if (!subjects.includes(oldName)) {
            alertMessage("Subject not found", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        if (subjects.includes(newName)) {
            alertMessage(`Subject "${newName}" already exists`, "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        pendingSubjectChanges.push({
            type: 'rename',
            oldName: oldName,
            newName: newName
        });
        
        const index = subjects.indexOf(oldName);
        subjects[index] = newName;
        renderSubjectManagementList();
        updateSubjectSelects();
        
        alertMessage(`Subject will be renamed from "${oldName}" to "${newName}"`, "bg-gradient-to-r from-blue-500 to-cyan-500");
    }
    
    function deleteSubject(subjectName) {
        if (!subjects.includes(subjectName)) {
            alertMessage("Subject not found", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        let hasContent = false;
        let contentDetails = [];
        
        if (quizData[subjectName]) {
            const questionCount = Object.values(quizData[subjectName]).reduce((sum, level) => sum + (level.length || 0), 0);
            if (questionCount > 0) {
                hasContent = true;
                contentDetails.push(`${questionCount} questions`);
            }
        }
        
        if (resources[subjectName]) {
            let resourceCount = 0;
            Object.values(resources[subjectName]).forEach(level => {
                if (level.pdfs) resourceCount += level.pdfs.length;
                if (level.videos) resourceCount += level.videos.length;
                if (level.urls) resourceCount += level.urls.length;
            });
            if (resourceCount > 0) {
                hasContent = true;
                contentDetails.push(`${resourceCount} resources`);
            }
        }
        
        let userProgressCount = 0;
        mockUsers.forEach(user => {
            if (user.levelProgress && user.levelProgress[subjectName]) {
                userProgressCount += Object.keys(user.levelProgress[subjectName]).length;
            }
        });
        if (userProgressCount > 0) {
            hasContent = true;
            contentDetails.push(`${userProgressCount} user progress records`);
        }
        
        if (hasContent) {
            alertMessage(
                `Cannot delete "${subjectName}" because it contains: ${contentDetails.join(', ')}. ` +
                `Please remove all content first.`,
                "bg-gradient-to-r from-red-500 to-pink-500"
            );
            return;
        }
        
        if (!confirm(`Are you sure you want to delete subject "${subjectName}"?`)) {
            return;
        }
        
        pendingSubjectChanges.push({
            type: 'delete',
            subjectName: subjectName
        });
        
        subjects = subjects.filter(s => s !== subjectName);
        renderSubjectManagementList();
        updateSubjectSelects();
        
        alertMessage(`Subject "${subjectName}" will be deleted`, "bg-gradient-to-r from-blue-500 to-cyan-500");
    }
    
    function saveSubjectChanges() {
        pendingSubjectChanges.forEach(change => {
            if (change.type === 'rename') {
                if (quizData[change.oldName]) {
                    quizData[change.newName] = quizData[change.oldName];
                    delete quizData[change.oldName];
                }
                
                if (resources[change.oldName]) {
                    resources[change.newName] = resources[change.oldName];
                    delete resources[change.oldName];
                }
                
                mockUsers.forEach(user => {
                    if (user.levelProgress && user.levelProgress[change.oldName]) {
                        user.levelProgress[change.newName] = user.levelProgress[change.oldName];
                        delete user.levelProgress[change.oldName];
                    }
                    
                    if (user.testHistory) {
                        user.testHistory.forEach(test => {
                            if (test.subject === change.oldName) {
                                test.subject = change.newName;
                            }
                        });
                    }
                    
                    if (user.lastAttemptDetails && user.lastAttemptDetails.subject === change.oldName) {
                        user.lastAttemptDetails.subject = change.newName;
                    }
                });
                
            } else if (change.type === 'delete') {
                delete quizData[change.subjectName];
                delete resources[change.subjectName];
                
                mockUsers.forEach(user => {
                    if (user.levelProgress) {
                        delete user.levelProgress[change.subjectName];
                    }
                    
                    if (user.testHistory) {
                        user.testHistory = user.testHistory.filter(test => test.subject !== change.subjectName);
                    }
                    
                    if (user.lastAttemptDetails && user.lastAttemptDetails.subject === change.subjectName) {
                        user.lastAttemptDetails = {};
                    }
                });
            }
        });
        
        pendingSubjectChanges = [];
        
        saveSubjects();
        saveQuizData();
        saveResourcesMeta();
        saveUsers();
        
        if (currentSubject && !subjects.includes(currentSubject)) {
            currentSubject = subjects[0] || '';
            renderWelcomeScreen();
        }
        
        closeSubjectManagement();
        alertMessage("Subject changes saved successfully", "bg-gradient-to-r from-green-500 to-teal-500");
    }
    
    function openSubjectManagement() {
        document.body.classList.add('modal-open');
        document.getElementById('subjectManagementModal').style.display = 'flex';
        renderSubjectManagementList();
    }
    
    function closeSubjectManagement() {
        document.body.classList.remove('modal-open');
        document.getElementById('subjectManagementModal').style.display = 'none';
        pendingSubjectChanges = [];
        loadSubjects();
        updateSubjectSelects();
    }
    
    function renderSubjectManagementList() {
        const container = document.getElementById('subjectListContainer');
        if (!container) return;
        
        if (subjects.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6 text-blue-600">
                    <i class="fas fa-book-open text-3xl mb-3"></i>
                    <p class="font-semibold">No subjects yet. Add your first subject above!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = subjects.map((subject, index) => {
            let hasContent = false;
            if (quizData[subject]) {
                const questionCount = Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0);
                if (questionCount > 0) hasContent = true;
            }
            
            return `
                <div class="subject-management-item">
                    <div class="flex-grow">
                        <div class="font-bold text-gray-800 text-lg">${subject}</div>
                        <div class="text-sm ${hasContent ? 'text-amber-600' : 'text-green-600'}">
                            ${hasContent ? '<i class="fas fa-exclamation-circle mr-2"></i> Contains content' : '<i class="fas fa-check-circle mr-2"></i> Ready'}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button type="button" onclick="editSubjectName('${subject}')" 
                                class="btn-primary p-2 rounded-lg" title="Rename">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="deleteSubject('${subject}')" 
                                class="btn-danger p-2 rounded-lg ${hasContent ? 'opacity-50 cursor-not-allowed' : ''}" 
                                title="${hasContent ? 'Cannot delete - contains content' : 'Delete'}" 
                                ${hasContent ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function editSubjectName(oldName) {
        const newName = prompt(`Rename "${oldName}" to:`, oldName);
        if (newName && newName.trim() && newName !== oldName) {
            renameSubject(oldName, newName.trim());
        }
    }
    
    function openSubjectManagementFromUploader() {
        closeBulkUploader();
        setTimeout(() => openSubjectManagement(), 100);
    }
    
    function openSubjectManagementFromManual() {
        closeManualExamCreator();
        setTimeout(() => openSubjectManagement(), 100);
    }
    
    function openSubjectManagementFromResource() {
        closeResourceUploader();
        setTimeout(() => openSubjectManagement(), 100);
    }

    // ==== DATA MANAGEMENT ====
    function loadUsers() {
        const users = localStorage.getItem(STORAGE_KEY);
        if (users) mockUsers = JSON.parse(users);
        mockUsers.forEach(u => {
            if(!u.testHistory) u.testHistory = [];
        });
    }
    
    function saveUsers() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(mockUsers));
    }
    
    function loadSettings() {
        const settings = localStorage.getItem(SETTINGS_KEY);
        if (settings) quizSettings = JSON.parse(settings);
        if(!quizSettings.minutesPerQuestion || quizSettings.minutesPerQuestion <= 0) quizSettings.minutesPerQuestion = 1;
    }
    
    function saveSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(quizSettings));
    }
    
    function loadQuizData() {
        const data = localStorage.getItem(QUIZ_DATA_KEY);
        if (data) {
            const savedData = JSON.parse(data);
            
            if (savedData.Math && savedData.Reading && savedData.Science && savedData["Computer Science"]) {
                quizData = savedData;
            } else {
                quizData = savedData;
                
                subjects.forEach(subject => {
                    if (!quizData[subject]) {
                        quizData[subject] = {};
                    }
                });
            }
        } else {
            subjects.forEach(subject => {
                quizData[subject] = {};
            });
        }
    }
    
    function saveQuizData() {
        localStorage.setItem(QUIZ_DATA_KEY, JSON.stringify(quizData));
    }
    
    function loadResources() {
        const res = localStorage.getItem(RESOURCES_KEY);
        if (res) {
            resources = JSON.parse(res);
            
            subjects.forEach(subject => {
                if (!resources[subject]) {
                    resources[subject] = {};
                }
                
                // Ensure each level has urls array
                for (let level = 1; level <= 10; level++) {
                    if (resources[subject][level] && !resources[subject][level].urls) {
                        resources[subject][level].urls = [];
                    }
                }
            });
        } else {
            subjects.forEach(subject => {
                resources[subject] = {};
            });
        }
    }
    
    function saveResourcesMeta() {
        localStorage.setItem(RESOURCES_KEY, JSON.stringify(resources));
    }

    // ==== RESOURCE HANDLING ====
    async function openResource(id) {
        alertMessage("Opening resource...", "bg-gradient-to-r from-blue-500 to-cyan-500");
        try {
            const fileBlob = await getFileFromDB(id);
            if (fileBlob) {
                const url = URL.createObjectURL(fileBlob);
                window.open(url, '_blank');
            } else {
                alertMessage("Resource not found locally.", "bg-gradient-to-r from-red-500 to-pink-500");
            }
        } catch (e) {
            console.error(e);
            alertMessage("Error opening resource.", "bg-gradient-to-r from-red-500 to-pink-500");
        }
    }
    
    // ==== URL RESOURCE HANDLING ====
    function openUrlResource(url) {
        if (url && url.startsWith('http')) {
            window.open(url, '_blank');
        } else {
            alertMessage("Invalid URL", "bg-gradient-to-r from-red-500 to-pink-500");
        }
    }

    // ==== GLOBAL RESOURCE MENU SYSTEM ====
    function openGlobalMenu(btn, event, subject, level, type, index, resourceId = null) {
        if (event) event.stopPropagation();
        
        const menu = document.getElementById('globalResourceMenu');
        
        if (type === 'exam') {
            menu.innerHTML = `
                <button onclick="editExam('${subject}', ${level})">
                    <i class="fas fa-edit"></i> Edit Exam
                </button>
                <button onclick="deleteExam('${subject}', ${level})" class="text-red-500 font-bold">
                    <i class="fas fa-trash"></i> Delete Exam
                </button>
            `;
        } else if (type === 'urls') {
            menu.innerHTML = `
                <button onclick="renameUrlResource('${subject}', ${level}, ${index}, event)">
                    <i class="fas fa-edit"></i> Rename
                </button>
                <button onclick="deleteUrlResource('${subject}', ${level}, ${index}, event)" class="text-red-500 font-bold">
                    <i class="fas fa-trash"></i> Delete
                </button>
            `;
        } else {
            menu.innerHTML = `
                <button onclick="renameResource('${subject}', '${level}', '${type}', ${index}, event)">
                    <i class="fas fa-edit"></i> Rename
                </button>
                <button onclick="deleteResource('${subject}', '${level}', '${type}', ${index}, event)" class="text-red-500 font-bold">
                    <i class="fas fa-trash"></i> Delete
                </button>
            `;
        }
        
        const rect = btn.getBoundingClientRect();
        menu.style.display = 'block';
        menu.style.top = `${rect.bottom + 5}px`;
        
        const menuWidth = 150;
        let leftPos = rect.right - menuWidth;
        if (leftPos < 5) leftPos = 5; 
        
        menu.style.left = `${leftPos}px`;
        
        setTimeout(() => {
            const closeMenuHandler = function(e) {
                if (!menu.contains(e.target) && e.target !== btn) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenuHandler);
                }
            };
            document.addEventListener('click', closeMenuHandler);
        }, 10);
    }

    // ==== LEVEL MANAGEMENT FUNCTIONS ====
    function openLevelMenu(btn, event, subject, level) {
        if (event) event.stopPropagation();
        
        const menu = document.getElementById('globalResourceMenu');
        menu.innerHTML = `
            <button onclick="openLevelRenameModal('${subject}', ${level})">
                <i class="fas fa-edit"></i> Rename Level
            </button>
            <button onclick="editLevelSettings('${subject}', ${level})">
                <i class="fas fa-cog"></i> Edit Level Content
            </button>
            <button onclick="deleteLevel('${subject}', ${level})" class="text-red-500 font-bold">
                <i class="fas fa-trash"></i> Delete Level
            </button>
        `;
        
        const rect = btn.getBoundingClientRect();
        menu.style.display = 'block';
        menu.style.top = `${rect.bottom + 5}px`;
        menu.style.left = `${rect.left}px`;
        
        setTimeout(() => {
            const closeMenuHandler = function(e) {
                if (!menu.contains(e.target) && e.target !== btn) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenuHandler);
                }
            };
            document.addEventListener('click', closeMenuHandler);
        }, 10);
    }
    
    function editLevelSettings(subject, level) {
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        // Open manual exam creator for this level
        openManualExamCreatorForSubject(subject, level, true);
    }
    
    function deleteLevel(subject, level) {
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        if(confirm(`Are you sure you want to delete Level ${level} for ${subject}? This will remove all questions and resources for this level.`)) {
            // Delete quiz data
            if (quizData[subject] && quizData[subject][level]) {
                delete quizData[subject][level];
                saveQuizData();
            }
            
            // Delete resources
            if (resources[subject] && resources[subject][level]) {
                delete resources[subject][level];
                saveResourcesMeta();
            }
            
            // Remove display name
            const key = `${subject}_${level}`;
            if (levelDisplayNames[key]) {
                delete levelDisplayNames[key];
                saveLevelDisplayNames();
            }
            
            // Remove from user progress
            mockUsers.forEach(user => {
                if (user.levelProgress && user.levelProgress[subject]) {
                    delete user.levelProgress[subject][level];
                }
                
                // Remove from test history
                if (user.testHistory) {
                    user.testHistory = user.testHistory.filter(test => 
                        !(test.subject === subject && test.level === level)
                    );
                }
            });
            saveUsers();
            
            alertMessage(`Level ${level} deleted for ${subject}`, "bg-gradient-to-r from-green-500 to-teal-500");
            renderSubjectLevels(subject);
        }
    }

    function renameResource(subject, level, type, index, event) {
        if (event) event.stopPropagation();
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        const item = resources[subject][level][type][index];
        const newName = prompt("Rename resource to:", item.name);
        if(newName && newName.trim() !== "") {
            resources[subject][level][type][index].name = newName.trim();
            saveResourcesMeta();
            renderSubjectLevels(subject);
        }
    }
    
    function renameUrlResource(subject, level, index, event) {
        if (event) event.stopPropagation();
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        const item = resources[subject][level].urls[index];
        const newName = prompt("Rename URL to:", item.name);
        if(newName && newName.trim() !== "") {
            resources[subject][level].urls[index].name = newName.trim();
            saveResourcesMeta();
            renderSubjectLevels(subject);
        }
    }

    function deleteResource(subject, level, type, index, event) {
        if (event) event.stopPropagation();
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        if(confirm("Are you sure you want to delete this file?")) {
            resources[subject][level][type].splice(index, 1);
            saveResourcesMeta();
            renderSubjectLevels(subject);
        }
    }
    
    function deleteUrlResource(subject, level, index, event) {
        if (event) event.stopPropagation();
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        if(confirm("Are you sure you want to delete this URL?")) {
            resources[subject][level].urls.splice(index, 1);
            saveResourcesMeta();
            renderSubjectLevels(subject);
        }
    }
    
    // ==== EXAM EDIT/DELETE FUNCTIONS ====
    function editExam(subject, level) {
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        const questions = quizData[subject]?.[level] || [];
        if (questions.length === 0) {
            alertMessage("No questions found for this exam", "bg-gradient-to-r from-yellow-500 to-amber-500");
            return;
        }
        
        // Open manual exam creator with existing questions
        openManualExamCreatorForSubject(subject, level, true);
    }
    
    function deleteExam(subject, level) {
        document.getElementById('globalResourceMenu').style.display = 'none';
        
        if(confirm("Are you sure you want to delete this entire exam? This will remove all questions for this level.")) {
            if (quizData[subject] && quizData[subject][level]) {
                delete quizData[subject][level];
                saveQuizData();
                alertMessage(`Exam deleted for ${subject} Level ${level}`, "bg-gradient-to-r from-green-500 to-teal-500");
                renderSubjectLevels(subject);
            }
        }
    }

    // ==== UI RENDERING FUNCTIONS ====
    function renderAuthScreen() {
        // Show admin footer in auth screen
        document.getElementById('adminFooter').style.display = 'block';
        
        quizApp.innerHTML = `
            <div class="space-y-8 flex flex-col h-full justify-center">
                <div class="text-center">
                    <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-blue-100 to-cyan-100 mb-4">
                        <i class="fas fa-graduation-cap text-4xl text-blue-500"></i>
                    </div>
                    <!-- CHANGED: "Welcome Back!" to "Welcome !" -->
                    <h3 class="text-2xl font-bold text-blue-700 mb-1">Welcome !</h3>
                </div>
                <form onsubmit="event.preventDefault(); handleSignIn()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2">Your Email</label>
                            <input type="email" id="signInUsername" placeholder="student@example.com" required 
                                   class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2">Password</label>
                            <input type="password" id="signInPassword" placeholder="" required 
                                   class="input-field">
                        </div>
                    </div>
                    <button type="submit" 
                            class="btn-primary w-full py-4 rounded-xl text-lg mt-8 shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                    </button>
                </form>
                <div class="text-center mt-4">
                    <p class="text-blue-600 text-sm mb-2">Don't have an account?</p>
                    <button onclick="renderSignUpForm()" class="text-blue-600 font-semibold hover:text-blue-800 text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300">
                        Create an Account
                    </button>
                </div>
            </div>`;
    }

    function renderSignUpForm() {
        headerTitle.textContent = "Create Account";
        // Show admin footer in sign up screen
        document.getElementById('adminFooter').style.display = 'block';
        
        quizApp.innerHTML = `
            <div class="space-y-8 flex flex-col h-full justify-center">
                <div class="text-center">
                    <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-green-100 to-teal-100 mb-4">
                        <i class="fas fa-user-plus text-4xl text-green-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-blue-700 mb-1">Join the Learning Community!</h3>
                </div>
                <form onsubmit="event.preventDefault(); handleSignUp()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2">Your Name</label>
                            <input type="text" id="signUpName" placeholder="John Smith" required 
                                   class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2">Your Email</label>
                            <input type="email" id="signUpUsername" placeholder="student@example.com" required 
                                   class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2">Password</label>
                            <input type="password" id="signUpPassword" placeholder="" required 
                                   class="input-field">
                        </div>
                    </div>
                    <button type="submit" 
                            class="btn-success w-full py-4 rounded-xl text-lg mt-8 shadow-lg">
                        <i class="fas fa-user-check mr-2"></i> Create Account
                    </button>
                </form>
                <div class="text-center mt-4">
                    <button onclick="renderAuthScreen()" class="text-blue-600 hover:text-blue-800 font-semibold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Sign In
                    </button>
                </div>
            </div>`;
    }

    function handleSignIn() {
        const email = document.getElementById('signInUsername').value;
        const password = document.getElementById('signInPassword').value;
        const user = mockUsers.find(u => u.email === email && u.password === password);
        
        if (user) {
            isAuthenticated = true;
            currentUser = user;
            if(!currentUser.testHistory) currentUser.testHistory = [];
            alertMessage(`Welcome back, ${currentUser.name}!`, 'bg-gradient-to-r from-green-500 to-teal-500');
            renderWelcomeScreen();
        } else {
            alertMessage('Sign In failed. Check credentials.', 'bg-gradient-to-r from-red-500 to-pink-500');
        }
    }

    function handleSignUp() {
        const name = document.getElementById('signUpName').value.trim();
        const email = document.getElementById('signUpUsername').value;
        const password = document.getElementById('signUpPassword').value;
        
        if (!name || !email || !password) return alertMessage('All fields required', 'bg-gradient-to-r from-red-500 to-pink-500');
        if (mockUsers.some(u => u.email === email)) return alertMessage('Email exists', 'bg-gradient-to-r from-red-500 to-pink-500');
        
        const newUser = {
            username: name.replace(/\s/g, '').toLowerCase(),
            password: password,
            name: name,
            email: email,
            grade: "1st Grade",
            quizzesTaken: 0,
            lastAttempt: null,
            levelProgress: {},
            lastAttemptDetails: {},
            testHistory: [],
            role: "student"
        };
        
        mockUsers.push(newUser);
        saveUsers();
        isAuthenticated = true;
        currentUser = newUser;
        alertMessage("Account Created Successfully!", 'bg-gradient-to-r from-green-500 to-teal-500');
        renderWelcomeScreen();
    }

    function handleSignOut() {
        isAuthenticated = false;
        currentUser = null;
        renderAuthScreen();
    }

    function renderWelcomeScreen() {
        if (!isAuthenticated) return renderAuthScreen();
        headerTitle.textContent = `Welcome, ${currentUser.name}!`;
        
        // Show admin footer for admin users only
        if (currentUser.role === 'admin') {
            document.getElementById('adminFooter').style.display = 'block';
        } else {
            document.getElementById('adminFooter').style.display = 'none';
        }
        
        quizApp.innerHTML = `
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center px-2 mb-4">
                     <button onclick="renderStudentProfile()" class="btn-primary px-4 py-2 rounded-xl text-sm flex items-center">
                        <i class="fas fa-user-graduate mr-2"></i> My Profile
                     </button>
                     <div class="text-xs font-semibold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                        <i class="fas fa-star mr-1"></i> Student
                     </div>
                </div>
                
                <div class="flex-grow flex flex-col justify-center space-y-6">
                    <h3 class="text-xl font-bold text-blue-700 text-center mb-4">Choose a Subject</h3>
                    <div class="grid grid-cols-2 gap-4">
                        ${subjects.map(subject => `
                            <button onclick="renderSubjectLevels('${subject}')" 
                                    class="subject-btn">
                                <i class="fas fa-book-open text-2xl mb-2 opacity-80"></i>
                                ${subject}
                            </button>
                        `).join('')}
                    </div>
                    
                    ${currentUser.role === 'admin' ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 shadow-sm">
                        <p class="text-xs text-blue-700 uppercase font-bold text-center mb-3">Admin Tools</p>
                        <div class="grid grid-cols-5 gap-2">
                            <button onclick="openBulkUploader()" class="btn-primary p-2 rounded-lg text-xs flex flex-col items-center"><i class="fas fa-file-upload mb-1 text-lg"></i> Bulk</button>
                            <button onclick="openManualExamCreator()" class="btn-success p-2 rounded-lg text-xs flex flex-col items-center"><i class="fas fa-edit mb-1 text-lg"></i> Manual</button>
                            <button onclick="openResourceUploader()" class="btn-purple p-2 rounded-lg text-xs flex flex-col items-center"><i class="fas fa-folder-open mb-1 text-lg"></i> Res.</button>
                            <button onclick="openUrlManager()" class="url-button p-2 rounded-lg text-xs flex flex-col items-center"><i class="fas fa-link mb-1 text-lg"></i> URLs</button>
                            <button onclick="openSubjectManagement()" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-2 rounded-lg text-xs flex flex-col items-center"><i class="fas fa-book mb-1 text-lg"></i> Subjects</button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>`;
    }
    
    function openUrlManager() {
        openResourceUploader();
        resetUrlInputs();
    }

    function renderStudentProfile() {
        if (!isAuthenticated) return renderAuthScreen();
        headerTitle.textContent = "My Profile";
        
        // Show admin footer for admin users only
        if (currentUser.role === 'admin') {
            document.getElementById('adminFooter').style.display = 'block';
        } else {
            document.getElementById('adminFooter').style.display = 'none';
        }
        
        const history = currentUser.testHistory || [];
        const avgScore = history.length > 0 ? Math.round(history.reduce((a, b) => a + (b.score || 0), 0) / history.length) : 0;

        quizApp.innerHTML = `
            <div class="flex flex-col h-full">
                <button onclick="renderWelcomeScreen()" class="self-start btn-secondary px-4 py-2 rounded-lg text-xs mb-4"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-2xl p-5 shadow-sm mb-6 flex items-center space-x-5">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full p-4 text-white text-3xl">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">${currentUser.name}</h2>
                        <p class="text-sm text-blue-600">${currentUser.email}</p>
                        <div class="flex space-x-3 mt-3">
                            <span class="text-xs font-bold bg-gradient-to-r from-green-100 to-green-200 text-green-700 px-3 py-1.5 rounded-full">Tests: ${history.length}</span>
                            <span class="text-xs font-bold bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-700 px-3 py-1.5 rounded-full">Avg: ${avgScore}%</span>
                        </div>
                    </div>
                </div>

                <h3 class="text-sm font-bold text-blue-700 mb-3 uppercase tracking-wide flex items-center">
                    <i class="fas fa-history mr-2"></i> Test History
                </h3>
                
                <div class="flex-grow overflow-y-auto space-y-3 pb-3">
                    ${history.length === 0 ? 
                        `<div class="text-center text-blue-400 py-10 flex flex-col items-center">
                            <i class="fas fa-clipboard-check text-4xl mb-3"></i>
                            <p class="font-semibold">No tests taken yet!</p>
                            <p class="text-xs mt-1">Start learning to see your progress here</p>
                         </div>` : 
                        history.map(test => `
                        <div class="bg-gradient-to-r ${test.score >= 80 ? 'from-green-50 to-emerald-50 border-l-4 border-green-500' : (test.score >= 50 ? 'from-yellow-50 to-amber-50 border-l-4 border-yellow-500' : 'from-red-50 to-pink-50 border-l-4 border-red-500')} rounded-r-xl shadow-sm p-4 hover:shadow-md transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-gray-800 text-sm">${test.subject} <span class="text-xs font-normal text-blue-600">Level ${test.level}</span></p>
                                    <p class="text-xs text-blue-500 mt-1.5"><i class="far fa-clock mr-1"></i> ${test.date} ${test.time ? `at ${test.time}` : ''}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xl font-bold ${test.score >= 80 ? 'text-green-600' : (test.score >= 50 ? 'text-yellow-600' : 'text-red-600')}">${test.score}%</p>
                                    <p class="text-xs text-gray-500">${test.scoreRaw || ''}</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-blue-100 flex justify-between text-xs text-blue-500">
                                <span><i class="fas fa-stopwatch text-blue-400 mr-1"></i> Time: ${test.duration || 'N/A'}</span>
                                <span><i class="fas fa-chart-line text-green-400 mr-1"></i> Performance</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderSubjectLevels(subject) {
        if (!isAuthenticated) return renderAuthScreen();
        currentSubject = subject;
        headerTitle.textContent = `${subject} - Levels`;
        
        // HIDE ADMIN FOOTER WHEN SUBJECT IS SELECTED (as shown in blue arrow screen)
        document.getElementById('adminFooter').style.display = 'none';
        
        const subRes = resources[subject] || {};
        const getResList = (level, type) => {
            if(subRes[level] && subRes[level][type] && Array.isArray(subRes[level][type])) {
                return subRes[level][type];
            }
            return [];
        };
        
        let hasAnyRes = false;
        for(let i=1; i<=10; i++) {
            if(getResList(i, 'pdfs').length > 0 || getResList(i, 'videos').length > 0 || (subRes[i] && subRes[i].urls && subRes[i].urls.length > 0)) hasAnyRes = true;
        }
        
        // Close menus when clicking outside
        quizApp.onclick = function(event) {
            if (!event.target.closest('.resource-item') && !event.target.closest('#globalResourceMenu')) {
                document.getElementById('globalResourceMenu').style.display = 'none';
            }
        };
        
        quizApp.innerHTML = `
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="renderWelcomeScreen()" class="btn-secondary px-4 py-2 rounded-lg text-xs"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                    ${currentUser.role === 'admin' ? `
                    <div class="flex space-x-2">
                        <button onclick="openManualExamCreatorForSubject('${subject}')" class="btn-success px-3 py-1.5 text-xs font-bold rounded-lg"><i class="fas fa-plus mr-1"></i> Questions</button>
                        <button onclick="openResourceUploaderForSubject('${subject}')" class="btn-purple px-3 py-1.5 text-xs font-bold rounded-lg"><i class="fas fa-upload mr-1"></i> Resources</button>
                    </div>` : ''}
                </div>

                ${hasAnyRes ? `
                <div class="learning-materials bg-gradient-to-b from-blue-50 to-blue-100 p-3 rounded-2xl border border-blue-300 mb-4 shadow-inner">
                    <h4 class="font-bold text-blue-800 text-sm uppercase mb-2 sticky top-0 bg-blue-100 py-2 px-3 rounded-lg border-b border-blue-200 z-10 flex items-center">
                        <i class="fas fa-book-reader mr-2 text-lg"></i> Learning Materials
                    </h4>
                    <div class="space-y-3">
                        ${[1,2,3,4,5,6,7,8,9,10].map(level => {
                            const pdfs = getResList(level, 'pdfs');
                            const videos = getResList(level, 'videos');
                            const urls = subRes[level]?.urls || [];
                            const examQuestions = quizData[subject]?.[level] || [];
                            const hasExam = examQuestions.length > 0;
                            const hasResources = pdfs.length > 0 || videos.length > 0 || urls.length > 0;
                            
                            if(!hasExam && !hasResources) return '';
                            
                            let examHtml = '';
                            let resourcesHtml = '';
                            
                            // Exam section
                            if (hasExam) {
                                examHtml = `
                                    <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 text-green-700 relative">
                                        <button type="button" onclick="startQuiz('${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                            <i class="fas fa-question-circle mr-3 w-5 text-green-500"></i> 
                                            <span class="truncate w-36 font-semibold">Exam (${examQuestions.length} questions)</span>
                                        </button>
                                        ${currentUser.role === 'admin' ? `
                                        <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'exam', 0)" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded"></button>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Resources section
                            if (pdfs.length > 0 || videos.length > 0 || urls.length > 0) {
                                resourcesHtml = `
                                    ${pdfs.map((pdf, idx) => `
                                        <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-red-50 hover:to-pink-50 text-red-700 relative">
                                            <button type="button" onclick="openResourceWithTracking('${pdf.id}', '${pdf.name}', '${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas ${pdf.name.endsWith('.html') || pdf.name.endsWith('.htm') ? 'fa-globe' : (pdf.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-pdf')} mr-3 w-5 text-red-500"></i> 
                                                <span class="truncate w-36">${pdf.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'pdfs', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded"></button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    ${videos.map((vid, idx) => `
                                        <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50 text-blue-700 relative">
                                            <button type="button" onclick="openResourceWithTracking('${vid.id}', '${vid.name}', '${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas fa-video mr-3 w-5 text-blue-500"></i> 
                                                <span class="truncate w-36">${vid.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'videos', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded"></button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    ${urls.map((urlItem, idx) => `
                                        <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-purple-50 hover:to-violet-50 text-purple-700 relative">
                                            <button type="button" onclick="openUrlResource('${urlItem.url}')" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas fa-link mr-3 w-5 text-purple-500"></i> 
                                                <span class="truncate w-36">${urlItem.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'urls', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded"></button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                `;
                            }
                            
                            const displayName = getLevelDisplayName(subject, level);
                            
                            return `
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(${level})">
                                    <span>${displayName}</span>
                                    <i id="accordion-icon-${level}" class="fas fa-chevron-down"></i>
                                </div>
                                <div id="accordion-content-${level}" class="accordion-content">
                                    <div class="accordion-resources-container">
                                        ${examHtml}
                                        ${resourcesHtml}
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>` : ''}

                <!-- BIG SCROLLBAR CONTAINER FOR ALL LEVELS -->
                <div id="levelsScrollContainer">
                    <div class="grid grid-cols-5 gap-3">
                        ${[1,2,3,4,5,6,7,8,9,10].map(level => {
                            const count = quizData[subject]?.[level]?.length || 0;
                            const progress = currentUser.levelProgress?.[subject]?.[level] || 0;
                            const pdfs = getResList(level, 'pdfs');
                            const videos = getResList(level, 'videos');
                            const urls = subRes[level]?.urls || [];
                            const hasRes = pdfs.length > 0 || videos.length > 0 || urls.length > 0;
                            const hasExam = count > 0;
                            const displayName = getLevelDisplayName(subject, level);
                            
                            // CHANGED TO GRAY COLOR SCHEME
                            let colorClass = count === 0 ? "bg-gradient-to-b from-gray-100 to-gray-200 text-gray-600 border-gray-400 gray-hover" : 
                                            (progress >= 80 ? "bg-gradient-to-b from-green-100 to-emerald-200 text-green-800 border-green-300 hover:from-green-200 hover:to-emerald-300" : 
                                            "bg-gradient-to-b from-gray-100 to-gray-200 text-gray-700 border-gray-300 gray-hover");
                            
                            return `
                            <div class="relative">
                                <button onclick="startQuiz('${subject}', ${level})" class="level-btn ${colorClass} w-full">
                                    <span class="text-sm font-bold">${displayName}</span>
                                    <span class="text-xs opacity-80 mt-1">${count} Qs</span>
                                    ${hasRes ? '<i class="fas fa-paperclip absolute top-2 right-2 text-xs text-purple-500"></i>' : ''}
                                    ${hasExam ? '<i class="fas fa-file-alt absolute top-2 left-2 text-xs text-green-500"></i>' : ''}
                                    ${progress > 0 ? `<div class="absolute bottom-8 w-4/5 h-1.5 bg-gray-300 rounded-full overflow-hidden"><div class="bg-gradient-to-r from-gray-500 to-gray-700 h-full rounded-full" style="width: ${Math.min(progress, 100)}%"></div></div>` : ''}
                                </button>
                                ${currentUser.role === 'admin' ? `
                                <div class="level-three-dots" onclick="openLevelMenu(this, event, '${subject}', ${level})"></div>
                                ` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
        
        // Initialize accordions - close all by default
        setTimeout(() => {
            document.querySelectorAll('.accordion-content').forEach(content => {
                content.classList.remove('expanded');
            });
            document.querySelectorAll('.accordion-header i').forEach(icon => {
                icon.className = 'fas fa-chevron-down';
            });
        }, 50);
    }

    // ==== QUIZ FUNCTIONS ====
    function startQuiz(subject, level) {
        const questions = quizData[subject]?.[level] || [];
        if (questions.length === 0) return alertMessage("No questions yet!", "bg-gradient-to-r from-yellow-500 to-amber-500");
        currentSubject = subject;
        currentLevel = level;
        currentQuestionIndex = 0;
        score = 0;
        startTime = new Date(); 
        startTimer();
        renderQuestion();
    }

    function renderQuestion() {
        isAnswered = false; 
        selectedOptions = [];
        const questions = quizData[currentSubject][currentLevel];
        if (currentQuestionIndex >= questions.length) return renderResults();
        
        const q = questions[currentQuestionIndex];
        const isMulti = q.type === 'checkbox' || (q.type === 'checkbox' && q.options.length > 2);
        
        headerTitle.textContent = `${currentSubject} ${getLevelDisplayName(currentSubject, currentLevel)} | ${currentQuestionIndex + 1}/${questions.length}`;
        
        let optionsHtml = '';
        let buttonHtml = '';

        if (isMulti) {
             optionsHtml = `
                <div class="space-y-3">
                    ${q.options.map((opt, i) => `
                        <label class="flex items-center w-full p-4 bg-gradient-to-r from-blue-50 to-cyan-50 text-blue-800 font-medium rounded-xl border-2 border-blue-200 hover:border-blue-300 hover:from-blue-100 hover:to-cyan-100 transition-all duration-300 text-sm cursor-pointer" id="opt-label-${i}">
                            <input type="checkbox" value="${opt}" onchange="toggleMultiSelect(this)" class="mr-4 h-5 w-5 text-blue-600">
                            ${opt}
                        </label>
                    `).join('')}
                </div>`;
                buttonHtml = `
                <div class="flex justify-between border-t border-blue-200 pt-5 mt-3">
                    <button onclick="prevQuestion()" ${currentQuestionIndex === 0 ? 'disabled class="opacity-50 cursor-not-allowed text-gray-400 font-bold text-sm"' : 'class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300"'}><i class="fas fa-arrow-left mr-1"></i> Prev</button>
                    <button id="actionBtn" onclick="submitMultiAnswer()" class="btn-primary px-6 py-3 rounded-xl text-sm shadow-lg">Check Answer</button>
                </div>`;
        } else {
             optionsHtml = `
                <div class="space-y-3">
                    ${q.options.map((opt, i) => `
                        <button onclick="selectAnswer('${opt}', this)" class="quiz-option">
                            <span class="group-hover:pl-2 transition-all duration-200">${opt}</span>
                        </button>
                    `).join('')}
                </div>`;
                buttonHtml = `
                <div class="flex justify-between border-t border-blue-200 pt-5 mt-3">
                    <button onclick="prevQuestion()" ${currentQuestionIndex === 0 ? 'disabled class="opacity-50 cursor-not-allowed text-gray-400 font-bold text-sm"' : 'class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300"'}><i class="fas fa-arrow-left mr-1"></i> Prev</button>
                    <button id="nextBtn" onclick="nextQuestion()" class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300 hidden">Next <i class="fas fa-arrow-right ml-1"></i></button>
                </div>`;
        }

        quizApp.innerHTML = `
            <div class="flex flex-col h-full justify-between">
                <div>
                    <button onclick="renderSubjectLevels(currentSubject)" class="text-sm text-blue-600 hover:text-blue-800 mb-5 border border-blue-300 hover:border-blue-500 px-3 py-1.5 rounded-lg transition-all duration-300"><i class="fas fa-times mr-1"></i> Exit Quiz</button>
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-2xl shadow-sm border border-blue-200 mb-6">
                        <p class="text-xl font-bold text-gray-800 text-center">${q.question}</p>
                    </div>
                    ${optionsHtml}
                    ${q.hint ? `<p class="mt-5 text-sm text-blue-500 text-center italic bg-blue-50 p-3 rounded-lg border border-blue-200"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i> Hint: ${q.hint}</p>` : ''}
                </div>
                ${buttonHtml}
            </div>`;
    }

    function toggleMultiSelect(checkbox) {
        if (checkbox.checked) selectedOptions.push(checkbox.value);
        else selectedOptions = selectedOptions.filter(o => o !== checkbox.value);
    }

   function isAnswerCorrect(userAnswer, question) {
    return normalizeText(userAnswer) === normalizeText(question.answer);
}

    function selectAnswer(ans, btn) {
        if (isAnswered) return; 
        isAnswered = true;
        
        const q = quizData[currentSubject][currentLevel][currentQuestionIndex];
        
        const isCorrect = isAnswerCorrect(ans, q);
        
        if (isCorrect) {
            score++;
            btn.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');
            btn.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
        } else {
            btn.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');
            btn.classList.add('bg-gradient-to-r', 'from-red-100', 'to-pink-200', 'text-red-800', 'border-red-400');
            
            setTimeout(() => {
                const correctAnswer = String(q.answer).trim();
                let correctOptionText = correctAnswer;
                
                if (/^\d+$/.test(correctAnswer)) {
                    const index = parseInt(correctAnswer) - 1;
                    if (index >= 0 && index < q.options.length) {
                        correctOptionText = q.options[index];
                    }
                }
                
                const allButtons = document.querySelectorAll('button[onclick^="selectAnswer"]');
                allButtons.forEach(button => {
                    const buttonText = button.textContent.trim();
                    if (normalizeText(buttonText) === normalizeText(correctOptionText)) {
                        button.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');
                        button.classList.remove('bg-gradient-to-r', 'from-red-100', 'to-pink-200', 'text-red-800', 'border-red-400');
                        button.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
                    }
                });
            }, 500);
        }
        
        const nextBtn = document.getElementById('nextBtn');
        if(nextBtn) {
            nextBtn.classList.remove('hidden');
            nextBtn.classList.add('flex', 'items-center');
        }
    }
    
    function submitMultiAnswer() {
        const btn = document.getElementById('actionBtn');
        if (isAnswered) {
            nextQuestion();
            return;
        }

        isAnswered = true;
        const q = quizData[currentSubject][currentLevel][currentQuestionIndex];
        
        let correctAnswerArray = [];
        const correctAnswer = String(q.answer).trim();
        
        if (correctAnswer.includes(',') || correctAnswer.includes('|')) {
            const separator = correctAnswer.includes(',') ? ',' : '|';
            correctAnswerArray = correctAnswer.split(separator).map(a => normalizeText(a.trim()));
        } else {
            correctAnswerArray = [normalizeText(correctAnswer)];
        }
        
        if (/^\d+([,|]\d+)*$/.test(correctAnswer)) {
            const indices = correctAnswer.split(/[,|]/).map(num => parseInt(num.trim()) - 1);
            correctAnswerArray = indices
                .filter(idx => idx >= 0 && idx < q.options.length)
                .map(idx => normalizeText(q.options[idx]));
        }
        
        const userAnswers = selectedOptions.map(a => normalizeText(a));
        
        const sortedCorrect = [...correctAnswerArray].sort();
        const sortedUser = [...userAnswers].sort();
        
        let isCorrect = sortedCorrect.length === sortedUser.length && 
                        sortedCorrect.every((val, idx) => val === sortedUser[idx]);
        
        if (isCorrect) {
            score++;
            alertMessage("Correct!", "bg-gradient-to-r from-green-500 to-teal-500");
        } else {
            alertMessage("Incorrect", "bg-gradient-to-r from-red-500 to-pink-500");
        }

        q.options.forEach((opt, idx) => {
             const label = document.getElementById(`opt-label-${idx}`);
             const checkbox = label.querySelector('input[type="checkbox"]');
             const isSelected = checkbox.checked;
             const isOptionCorrect = sortedCorrect.includes(normalizeText(opt));

             label.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');

             if (isSelected && isOptionCorrect) {
                 label.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
             } else if (isSelected && !isOptionCorrect) {
                 label.classList.add('bg-gradient-to-r', 'from-red-100', 'to-pink-200', 'text-red-800', 'border-red-400');
             } else if (!isSelected && isOptionCorrect) {
                 label.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
             } else {
                 label.classList.add('bg-gradient-to-r', 'from-gray-100', 'to-gray-200', 'text-gray-500', 'border-gray-300');
             }
        });

        btn.textContent = "Next ";
        btn.classList.remove('btn-primary');
        btn.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-pink-500', 'hover:from-purple-600', 'hover:to-pink-600');
    }
    
    function nextQuestion() {
        currentQuestionIndex++;
        renderQuestion();
    }
    
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion();
        }
    }

    function renderResults() {
        stopTimer();
        const endTime = new Date();
        const durationSec = Math.floor((endTime - startTime) / 1000);
        
        const total = quizData[currentSubject][currentLevel].length;
        const pct = Math.round((score / total) * 100);
        
        const uIdx = mockUsers.findIndex(u => u.email === currentUser.email);
        if (uIdx !== -1) {
            mockUsers[uIdx].quizzesTaken++;
            if (!mockUsers[uIdx].levelProgress[currentSubject]) mockUsers[uIdx].levelProgress[currentSubject] = {};
            mockUsers[uIdx].levelProgress[currentSubject][currentLevel] = Math.max(mockUsers[uIdx].levelProgress[currentSubject][currentLevel] || 0, pct);
            
            const newAttempt = {
                subject: currentSubject,
                level: currentLevel,
                score: pct,
                date: endTime.toLocaleDateString(),
                time: endTime.toLocaleTimeString(),
                duration: `${Math.floor(durationSec / 60)}m ${durationSec % 60}s`,
                scoreRaw: `${score}/${total}`
            };

            mockUsers[uIdx].lastAttemptDetails = newAttempt;

            if (!mockUsers[uIdx].testHistory) mockUsers[uIdx].testHistory = [];
            mockUsers[uIdx].testHistory.unshift(newAttempt);

            saveUsers();
        }

        headerTitle.textContent = "Quiz Complete";
        quizApp.innerHTML = `
            <div class="flex flex-col h-full justify-center text-center space-y-6">
                <div>
                    <div class="text-7xl mb-3">${pct >= 80 ? '' : (pct >= 50 ? '' : '')}</div>
                    <h3 class="text-2xl font-bold ${pct >= 80 ? 'text-green-600' : (pct >= 50 ? 'text-blue-600' : 'text-orange-600')}">${pct >= 80 ? 'Excellent Performance!' : (pct >= 50 ? 'Good Practice!' : 'Keep Practicing!')}</h3>
                    <p class="text-blue-500 text-sm mt-2">You scored</p>
                    <p class="text-6xl font-black ${pct >= 80 ? 'text-green-600' : (pct >= 50 ? 'text-blue-600' : 'text-orange-600')} my-3">${score}/${total}</p>
                    <p class="text-xl font-bold text-gray-400">${pct}%</p>
                </div>
                <div class="space-y-3">
                    ${pct < 80 ? `<button type="button" onclick="startQuiz('${currentSubject}', ${currentLevel})" class="btn-success w-full py-4 rounded-xl shadow-lg">Try Again</button>` : ''}
                    <button type="button" onclick="renderSubjectLevels('${currentSubject}')" class="btn-primary w-full py-4 rounded-xl shadow-lg">Back to Levels</button>
                </div>
            </div>`;
    }

    let timeLeft, timerInterval;
    function startTimer() {
        if (!quizSettings.timerEnabled) {
            timerDisplay.classList.add('hidden');
            return;
        }
        stopTimer();
        const qCount = quizData[currentSubject][currentLevel].length;
        timeLeft = qCount * (quizSettings.minutesPerQuestion * 60); 
        timerDisplay.classList.remove('hidden');
        updateTimerUI();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerUI();
            if (timeLeft <= 0) {
                stopTimer();
                alertMessage("Time's up!", "bg-gradient-to-r from-red-500 to-pink-500");
                renderResults();
            }
        }, 1000);
    }
    
    function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerDisplay.classList.add('hidden');
    }
    
    function updateTimerUI() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        timerDisplay.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
        timerDisplay.className = `text-base font-bold px-4 py-2 rounded-full shadow-lg text-white mb-2 ${timeLeft < 30 ? 'bg-gradient-to-r from-red-500 to-pink-500' : (timeLeft < 60 ? 'bg-gradient-to-r from-yellow-500 to-amber-500' : 'bg-gradient-to-r from-green-500 to-teal-500')}`;
    }

    // ==== ADMIN FUNCTIONS ====
    function openModal(id) {
        document.body.classList.add('modal-open');
        document.getElementById('passwordModal').style.display = 'flex';
        document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0');
        document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
    }
    
    function closeModal() {
        document.body.classList.remove('modal-open');
        document.getElementById('passwordModal').style.display = 'none';
    }
    
    function checkAdminPassword() {
        if (document.getElementById('passwordInput').value === adminPassword) {
            closeModal();
            renderAdminDashboard();
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }
    
    function renderAdminDashboard() {
        headerTitle.textContent = "Admin Dashboard";
        
        // SHOW ADMIN FOOTER IN ADMIN DASHBOARD
        document.getElementById('adminFooter').style.display = 'block';
        
        const allUsers = mockUsers; 
        const qTotal = Object.values(quizData).reduce((acc, sub) => acc + Object.values(sub).reduce((a, l) => a + l.length, 0), 0);
        
        updateSubjectSelects();
        
        quizApp.innerHTML = `
            <div class="flex flex-col h-full relative">
                <button type="button" onclick="renderWelcomeScreen()" class="absolute top-0 left-0 btn-secondary px-4 py-2 rounded-lg text-xs mb-4"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                
                <div class="mt-10 grid grid-cols-2 gap-4 mb-6">
                    <div onclick="scrollToUserList()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-blue-700">${mockUsers.length}</div>
                        <div class="text-xs text-blue-600 uppercase font-bold mt-1">Total Users</div>
                    </div>
                    <div onclick="showQuestionSummary()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-green-700">${qTotal}</div>
                        <div class="text-xs text-green-600 uppercase font-bold mt-1">Total Questions</div>
                    </div>
                    <div onclick="scrollToUserList()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-purple-700">${mockUsers.filter(u=>u.role!=='admin').length}</div>
                        <div class="text-xs text-purple-600 uppercase font-bold mt-1">Students</div>
                    </div>
                    <div onclick="showSubjectSummary()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-indigo-700">${subjects.length}</div>
                        <div class="text-xs text-indigo-600 uppercase font-bold mt-1">Subjects</div>
                    </div>
                </div>

                <div class="flex justify-between space-x-2 mb-6">
                    <button type="button" onclick="openBulkUploader()" class="btn-primary flex-1 py-3 rounded-xl text-sm"><i class="fas fa-file-csv mr-2"></i> Bulk</button>
                    <button type="button" onclick="openManualExamCreator()" class="btn-success flex-1 py-3 rounded-xl text-sm"><i class="fas fa-edit mr-2"></i> Manual</button>
                    <button type="button" onclick="openResourceUploader()" class="btn-purple flex-1 py-3 rounded-xl text-sm"><i class="fas fa-photo-video mr-2"></i> Res</button>
                    <button type="button" onclick="openUrlManager()" class="url-button flex-1 py-3 rounded-xl text-sm"><i class="fas fa-link mr-2"></i> URLs</button>
                    <button type="button" onclick="openSubjectManagement()" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white flex-1 py-3 rounded-xl text-sm hover:from-indigo-600 hover:to-purple-600"><i class="fas fa-book mr-2"></i> Subjects</button>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-2xl p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-blue-700">Timer (Mins/Q)</span>
                        <div class="flex items-center space-x-3">
                            <input type="number" id="adminTimerInput" value="${quizSettings.minutesPerQuestion}" class="w-16 p-2 border border-blue-300 rounded-lg text-center text-sm bg-white">
                            <button onclick="updateTimerSettings()" class="btn-primary px-3 py-2 rounded-lg text-xs">Set</button>
                            <button onclick="toggleTimer()" class="px-3 py-2 rounded-lg text-xs font-bold text-white ${quizSettings.timerEnabled ? 'bg-gradient-to-r from-green-500 to-teal-500' : 'bg-gradient-to-r from-red-500 to-pink-500'}">${quizSettings.timerEnabled ? 'ON' : 'OFF'}</button>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-2xl p-4 mb-6">
                    <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> Danger Zone</h4>
                    <p class="text-xs text-red-600 mb-3">Reset all quiz progress and scores</p>
                    <button type="button" onclick="openResetQuizModal()" class="btn-danger w-full py-3 rounded-xl text-sm flex items-center justify-center">
                        <i class="fas fa-trash-alt mr-2"></i> Reset All Quiz Progress
                    </button>
                </div>

                <div class="flex-grow flex flex-col min-h-0 bg-gradient-to-b from-white to-blue-50 border border-blue-200 rounded-2xl overflow-hidden shadow-sm" id="userManagementSection">
                    <div class="bg-gradient-to-r from-blue-100 to-cyan-100 p-3 border-b border-blue-200 flex justify-between items-center">
                        <h4 class="font-bold text-blue-700 text-sm">User Management (${allUsers.length})</h4>
                        <span class="text-xs text-blue-600">Scroll to view all</span>
                    </div>
                    <div class="overflow-y-auto p-3 space-y-3 flex-grow">
                        ${allUsers.length === 0 ? '<p class="text-center text-blue-400 text-sm py-6">No users yet.</p>' : ''}
                        ${allUsers.map(u => {
                            const last = u.lastAttemptDetails;
                            const lastAttemptStr = last && last.date ? 
                                `Last: ${last.subject} Lvl ${last.level} (${last.score}%) - ${last.duration} on ${last.date}` : 
                                'No attempts yet';
                            const isAdmin = u.role === 'admin';
                                
                            return `
                            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-white to-blue-50 border border-blue-100 rounded-xl shadow-sm hover:shadow-md hover:from-blue-50 hover:to-cyan-50 transition-all duration-300">
                                <div>
                                    <div class="font-bold text-gray-800 text-sm">${u.name} ${isAdmin ? '<span class="text-red-500 text-xs bg-red-50 px-2 py-0.5 rounded-full">Admin</span>' : ''}</div>
                                    <div class="text-xs text-blue-600">${u.email}</div>
                                    <div class="text-xs text-blue-500 mt-1 font-semibold">${lastAttemptStr}</div>
                                </div>
                                ${!isAdmin ? `<button type="button" onclick="deleteUser('${u.email}')" class="btn-danger p-2 rounded-lg text-xs"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            </div>`;
    }

    function showSubjectSummary() {
        let summaryHtml = '<div class="text-left space-y-3">';
        subjects.forEach(subject => {
            let questionCount = 0;
            let resourceCount = 0;
            
            if (quizData[subject]) {
                questionCount = Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0);
            }
            
            if (resources[subject]) {
                Object.values(resources[subject]).forEach(level => {
                    if (level.pdfs) resourceCount += level.pdfs.length;
                    if (level.videos) resourceCount += level.videos.length;
                    if (level.urls) resourceCount += level.urls.length;
                });
            }
            
            summaryHtml += `
                <div class="flex justify-between border-b border-blue-200 pb-2 text-sm">
                    <span class="font-semibold text-blue-700">${subject}</span>
                    <div class="flex space-x-4">
                        <span class="font-bold text-green-600">${questionCount} Qs</span>
                        <span class="text-blue-500">${resourceCount} Res</span>
                    </div>
                </div>`;
        });
        summaryHtml += '</div>';
        
        const modal = document.createElement('div');
        modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-[1100] backdrop-filter backdrop-blur-sm';
        modal.innerHTML = `
            <div class="bg-gradient-to-b from-white to-blue-50 p-6 rounded-2xl w-96 shadow-2xl border border-blue-200">
                <h3 class="text-lg font-bold text-blue-800 mb-4 text-center">Subject Summary</h3>
                ${summaryHtml}
                <button type="button" onclick="this.parentElement.parentElement.remove()" class="mt-6 w-full btn-primary py-3 rounded-xl text-sm font-bold">Close</button>
            </div>`;
        document.body.appendChild(modal);
    }

    function openResetQuizModal() {
        document.body.classList.add('modal-open');
        document.getElementById('resetQuizModal').style.display = 'flex';
        document.getElementById('resetModalContent').classList.remove('scale-95', 'opacity-0');
        document.getElementById('resetModalContent').classList.add('scale-100', 'opacity-100');
    }
    
    function closeResetModal() {
        document.body.classList.remove('modal-open');
        document.getElementById('resetQuizModal').style.display = 'none';
    }
    
    function confirmResetQuizProgress() {
        const password = document.getElementById('resetPasswordInput').value;
        
        if (password !== adminPassword) {
            document.getElementById('resetPasswordError').classList.remove('hidden');
            return;
        }
        
        mockUsers.forEach(user => {
            user.quizzesTaken = 0;
            user.lastAttempt = null;
            user.levelProgress = {};
            user.lastAttemptDetails = {};
            user.testHistory = [];
            
            if (user.role === 'admin') {
                user.role = 'admin';
            }
        });
        
        saveUsers();
        closeResetModal();
        
        if (currentUser) {
            const userIndex = mockUsers.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                currentUser = mockUsers[userIndex];
            }
        }
        
        alertMessage("All quiz progress has been reset!", "bg-gradient-to-r from-green-500 to-teal-500");
        renderAdminDashboard();
    }

    function scrollToUserList() {
        const el = document.getElementById('userManagementSection');
        if (el) el.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showQuestionSummary() {
        let summaryHtml = '<div class="text-left space-y-3">';
        subjects.forEach(s => {
            let count = 0;
            if (quizData[s]) {
                for(let l in quizData[s]) count += quizData[s][l].length;
            }
            summaryHtml += `<div class="flex justify-between border-b border-blue-200 pb-2 text-sm"><span class="font-semibold text-blue-700">${s}</span><span class="font-bold text-green-600">${count}</span></div>`;
        });
        summaryHtml += '</div>';
        
        const modal = document.createElement('div');
        modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-[1100] backdrop-filter backdrop-blur-sm';
        modal.innerHTML = `
            <div class="bg-gradient-to-b from-white to-blue-50 p-6 rounded-2xl w-80 shadow-2xl border border-blue-200">
                <h3 class="text-lg font-bold text-blue-800 mb-4 text-center">Question Breakdown</h3>
                ${summaryHtml}
                <button type="button" onclick="this.parentElement.parentElement.remove()" class="mt-6 w-full btn-primary py-3 rounded-xl text-sm font-bold">Close</button>
            </div>`;
        document.body.appendChild(modal);
    }

    function updateTimerSettings() {
        const val = parseFloat(document.getElementById('adminTimerInput').value);
        if (val > 0) {
            quizSettings.minutesPerQuestion = val;
            saveSettings();
            alertMessage(`Timer set to ${val} min/question`, "bg-gradient-to-r from-green-500 to-teal-500");
        }
    }
    
    function toggleTimer() {
        quizSettings.timerEnabled = !quizSettings.timerEnabled;
        saveSettings();
        renderAdminDashboard();
    }
    
    function deleteUser(email) {
        if(confirm("Delete user?")) {
            mockUsers = mockUsers.filter(u => u.email !== email);
            saveUsers();
            renderAdminDashboard();
        }
    }

    // ==== MANUAL EXAM CREATOR ====
    let isEditMode = false;
    let editSubject = '';
    let editLevel = 0;
    
    function openManualExamCreator(editMode = false, subject = '', level = 0) { 
        document.body.classList.add('modal-open');
        document.getElementById('manualExamModal').style.display = 'flex'; 
        document.getElementById('manualQuestionsContainer').innerHTML = '';
        
        isEditMode = editMode;
        editSubject = subject;
        editLevel = level;
        
        if (!editMode) {
            manualQuestions = [];
            addManualQuestion(); 
        } else {
            renderManualQuestions();
        }
    }
    
    function addManualQuestion() {
        const id = manualQuestions.length;
        manualQuestions.push({ type: 'radio', question: '', options: ['', ''], answer: '', hint: '' });
        
        renderManualQuestions();
    }
    
    function renderManualQuestions() {
        const container = document.getElementById('manualQuestionsContainer');
        container.innerHTML = '';
        
        manualQuestions.forEach((q, id) => {
            const d = document.createElement('div');
            d.className = 'question-item bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-200 mb-3';
            d.id = `q-item-${id}`;
            d.innerHTML = renderManualQuestionInputs(id);
            container.appendChild(d);
        });
    }
    
    function renderManualQuestionInputs(id) {
        const q = manualQuestions[id];
        let optionsHtml = '';

        if (q.type === 'radio') {
            optionsHtml = `
                <div class="space-y-2 mb-3">
                    ${q.options.map((opt, i) => `
                        <div class="flex items-center space-x-3 relative">
                            <input type="radio" name="correct-${id}" onclick="updateManualAnswer(${id}, '${i}')" ${q.answer === opt ? 'checked' : ''} class="h-5 w-5 text-blue-600">
                            <input type="text" placeholder="Option ${i+1}" value="${opt}" 
                                   class="w-full border border-blue-300 p-2.5 rounded-lg text-sm consistent-input" 
                                   oninput="updateManualOption(${id}, ${i}, this.value)">
                        </div>
                    `).join('')}
                </div>
                <button type="button" onclick="addManualOptionInput(${id})" class="text-sm text-blue-600 font-bold hover:text-blue-800"><i class="fas fa-plus-circle mr-1"></i> Add Option</button>
            `;
        } else if (q.type === 'checkbox') {
            const answers = q.answer ? q.answer.split(',').map(a => a.trim()) : [];
            optionsHtml = `
                <div class="space-y-2 mb-3">
                    ${q.options.map((opt, i) => `
                        <div class="flex items-center space-x-3 relative">
                            <input type="checkbox" onchange="updateManualMultiAnswer(${id}, this, ${i})" ${answers.includes(opt) ? 'checked' : ''} class="h-5 w-5 text-blue-600">
                            <input type="text" placeholder="Option ${i+1}" value="${opt}" 
                                   class="w-full border border-blue-300 p-2.5 rounded-lg text-sm consistent-input" 
                                   oninput="updateManualOption(${id}, ${i}, this.value)">
                        </div>
                    `).join('')}
                </div>
                <button type="button" onclick="addManualOptionInput(${id})" class="text-sm text-blue-600 font-bold hover:text-blue-800"><i class="fas fa-plus-circle mr-1"></i> Add Option</button>
            `;
        } else if (q.type === 'truefalse') {
            optionsHtml = `
                <div class="space-y-2 mb-3">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="correct-${id}" onclick="updateManualAnswer(${id}, '0')" ${q.answer === 'True' ? 'checked' : ''} class="h-5 w-5 text-blue-600">
                        <span class="text-sm font-semibold text-blue-700">True</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="correct-${id}" onclick="updateManualAnswer(${id}, '1')" ${q.answer === 'False' ? 'checked' : ''} class="h-5 w-5 text-blue-600">
                        <span class="text-sm font-semibold text-blue-700">False</span>
                    </div>
                </div>
            `;
        } else if (q.type === 'essay') {
            optionsHtml = `<div class="text-sm text-blue-500 italic mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">Essay: No options required.</div>`;
        }

        return `
            <div class="flex justify-between mb-3">
                <span class="font-bold text-sm text-blue-700">Question ${id+1}</span>
                <select class="text-sm border border-blue-300 p-2 rounded-lg consistent-input" onchange="changeManualType(${id}, this.value)">
                    <option value="radio" ${q.type==='radio'?'selected':''}>Single Choice</option>
                    <option value="checkbox" ${q.type==='checkbox'?'selected':''}>Multiple Choice</option>
                    <option value="truefalse" ${q.type==='truefalse'?'selected':''}>True/False</option>
                    <option value="essay" ${q.type==='essay'?'selected':''}>Essay</option>
                </select>
            </div>
            <input placeholder="Question Text" value="${q.question}" class="w-full border border-blue-300 p-3 rounded-lg mb-3 text-sm font-bold consistent-input" oninput="manualQuestions[${id}].question = this.value">
            <div class="mb-3">
                <label class="text-sm font-bold text-blue-700 mb-2 block">Options & Correct Answer:</label>
                ${optionsHtml}
            </div>
            <input id="q-ans-${id}" placeholder="Correct Answer (Auto-filled)" value="${q.answer}" class="w-full border border-green-300 p-2.5 rounded-lg mb-2 text-sm bg-gradient-to-r from-green-50 to-emerald-50 consistent-input" readonly>
        `;
    }

    function changeManualType(id, newType) {
        manualQuestions[id].type = newType;
        manualQuestions[id].answer = ''; 
        
        if (newType === 'truefalse') {
            manualQuestions[id].options = ['True', 'False'];
        } else if (newType === 'essay') {
            manualQuestions[id].options = [];
        } else if (manualQuestions[id].options.length < 2) {
            manualQuestions[id].options = ['', ''];
        }
        
        document.getElementById(`q-item-${id}`).innerHTML = renderManualQuestionInputs(id);
    }

    function addManualOptionInput(id) {
        manualQuestions[id].options.push('');
        document.getElementById(`q-item-${id}`).innerHTML = renderManualQuestionInputs(id);
    }

    function updateManualOption(id, idx, val) {
        manualQuestions[id].options[idx] = val;
    }

    function updateManualAnswer(id, idx) {
        const val = manualQuestions[id].options[idx];
        manualQuestions[id].answer = val;
        document.getElementById(`q-ans-${id}`).value = val;
    }

    function updateManualMultiAnswer(id, checkbox, idx) {
        const val = manualQuestions[id].options[idx];
        let curr = manualQuestions[id].answer ? manualQuestions[id].answer.split(',') : [];
        if(checkbox.checked) curr.push(val);
        else curr = curr.filter(v => v !== val);
        manualQuestions[id].answer = curr.join(',');
        document.getElementById(`q-ans-${id}`).value = manualQuestions[id].answer;
    }

    function saveManualExam() {
        const sub = document.getElementById('manualSubject').value;
        const lev = parseInt(document.getElementById('manualLevel').value); 
        
        const valid = manualQuestions.every(q => q.question && (q.type === 'essay' || (q.options.length > 0 && q.answer)));
        if (!valid) return alertMessage("Please fill all fields & select correct answers", "bg-gradient-to-r from-red-500 to-pink-500");

        if(!quizData[sub]) quizData[sub] = {};
        
        if (isEditMode && sub === editSubject && lev === editLevel) {
            quizData[sub][lev] = [];
        } else {
            if(!quizData[sub][lev]) quizData[sub][lev] = [];
        }
        
        manualQuestions.forEach(q => {
            const processedOptions = q.options.map(opt => String(opt).trim()).filter(opt => opt !== '');
            
            if (q.type === 'truefalse' && processedOptions.length < 2) {
                processedOptions.push('True', 'False');
            }
            
            if (processedOptions.length < 2 && q.type !== 'essay') {
                processedOptions.push('Option B', 'Option C', 'Option D');
            }
            
            quizData[sub][lev].push({
                question: q.question.trim(),
                options: processedOptions,
                answer: String(q.answer).trim(),
                type: q.type,
                hint: ''
            });
        });
        
        saveQuizData();
        closeManualExamCreator();
        alertMessage(`Exam ${isEditMode ? 'Updated' : 'Saved'} with ${manualQuestions.length} questions!`, "bg-gradient-to-r from-green-500 to-teal-500");
        
        renderSubjectLevels(sub);
    }
    
    function openManualExamCreatorForSubject(s, level = null, editMode = false) {
        document.getElementById('manualSubject').value = s;
        if (level) {
            document.getElementById('manualLevel').value = level;
            
            if (editMode) {
                manualQuestions = [];
                const existingQuestions = quizData[s]?.[level] || [];
                existingQuestions.forEach(q => {
                    manualQuestions.push({
                        type: q.type || 'radio',
                        question: q.question || '',
                        options: q.options || ['', ''],
                        answer: q.answer || '',
                        hint: q.hint || ''
                    });
                });
                
                if (manualQuestions.length === 0) {
                    manualQuestions.push({ type: 'radio', question: '', options: ['', ''], answer: '', hint: '' });
                }
            } else {
                manualQuestions = [];
                addManualQuestion();
            }
        } else {
            manualQuestions = [];
            addManualQuestion();
        }
        openManualExamCreator(editMode, s, level);
    }

    // ==== UPLOADER LOGIC ====
    function closeManualExamCreator() { 
        document.body.classList.remove('modal-open');
        document.getElementById('manualExamModal').style.display = 'none'; 
        isEditMode = false;
        editSubject = '';
        editLevel = 0;
    }
    
    function openResourceUploader() { 
        document.body.classList.add('modal-open');
        document.getElementById('resourceUploaderModal').style.display = 'flex'; 
        resetUrlInputs();
    }
    
    function closeResourceUploader() { 
        document.body.classList.remove('modal-open');
        document.getElementById('resourceUploaderModal').style.display = 'none'; 
    }
    
    function openBulkUploader() { 
        document.body.classList.add('modal-open');
        document.getElementById('bulkUploaderModal').style.display = 'flex'; 
    }
    
    function closeBulkUploader() { 
        document.body.classList.remove('modal-open');
        document.getElementById('bulkUploaderModal').style.display = 'none'; 
    }
    
    function openResourceUploaderForSubject(s) { 
        document.getElementById('resourceSubject').value = s; 
        openResourceUploader(); 
    }

    async function saveResources() {
        const subject = document.getElementById('resourceSubject').value;
        const level = parseInt(document.getElementById('resourceLevel').value);
        const pdf = document.getElementById('pdfFileInput').files[0];
        const video = document.getElementById('videoFileInput').files[0];
        const status = document.getElementById('resourceUploadStatus');

        if (!pdf && !video && urlInputs.every(url => !url.name.trim() && !url.url.trim())) {
            return alertMessage("Select a file or add a URL first", "bg-gradient-to-r from-red-500 to-pink-500");
        }
        
        status.textContent = "Saving to Database... do not close.";
        status.classList.remove('hidden');

        try {
            if (!resources[subject]) resources[subject] = {};
            if (!resources[subject][level]) resources[subject][level] = { pdfs: [], videos: [], urls: [] };
            if (!resources[subject][level].pdfs) resources[subject][level].pdfs = [];
            if (!resources[subject][level].videos) resources[subject][level].videos = [];
            if (!resources[subject][level].urls) resources[subject][level].urls = [];

            const date = new Date().toISOString();

            if (pdf) {
                const id = `pdf_${Date.now()}`;
                await saveFileToDB(pdf, id);
                resources[subject][level].pdfs.unshift({ id: id, name: pdf.name, date: date });
            }
            if (video) {
                const id = `vid_${Date.now()}`;
                await saveFileToDB(video, id);
                resources[subject][level].videos.unshift({ id: id, name: video.name, date: date });
            }
            
            // Save URLs
            urlInputs.forEach(url => {
                if (url.name.trim() && url.url.trim()) {
                    const id = `url_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    resources[subject][level].urls.unshift({ 
                        id: id, 
                        name: url.name.trim(), 
                        url: url.url.trim(), 
                        date: date 
                    });
                }
            });
            
            saveResourcesMeta();
            closeResourceUploader();
            alertMessage("Saved to Local Database!", "bg-gradient-to-r from-green-500 to-teal-500");
            if(currentSubject === subject) renderSubjectLevels(subject);
            
            // Reset file inputs
            document.getElementById('pdfFileInput').value = '';
            document.getElementById('videoFileInput').value = '';
            resetUrlInputs();
            
        } catch (e) {
            console.error(e);
            alertMessage("Error saving file. Device might be full.", "bg-gradient-to-r from-red-500 to-pink-500");
        }
        status.classList.add('hidden');
    }

   function processBulkUpload() {
    const file = document.getElementById('csvFileInput').files[0];
    const jsonFile = document.getElementById('jsonFileInput').files[0];

    // === JSON UPLOAD ===
    if (jsonFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                const s = data.subject || document.getElementById('uploadSubject').value;
                const l = parseInt(data.level || document.getElementById('uploadLevel').value);

                let count = 0;

                if (Array.isArray(data)) {
                    data.forEach(item => {
                        const qSubject = item.subject || s;
                        const qLevel = item.level ? parseInt(item.level) : l;
                        if (!quizData[qSubject]) quizData[qSubject] = {};
                        if (!quizData[qSubject][qLevel]) quizData[qSubject][qLevel] = [];

                        const qText = item.question || item.Question;
                        const qAns = item.answer || item.Answer || item.correct;
                        let qOpts = item.options || item.Options;
                        const qType = item.type || item.Type || 'radio';
                        const qHint = item.hint || item.Hint || '';

                        if (typeof qOpts === 'string') {
                            qOpts = qOpts.split('|').map(opt => opt.trim());
                        } else if (!Array.isArray(qOpts)) {
                            qOpts = [];
                        }

                        if (qOpts.length === 0 && qAns) {
                            qOpts = [
                                String(qAns).trim(),
                                "Incorrect Option 1",
                                "Incorrect Option 2",
                                "Incorrect Option 3"
                            ];
                        }

                        if (qText && qAns) {
                            let finalAnswer = "";
                            let rawVal = qAns;

                            if (Array.isArray(qAns) && qAns.length > 0) {
                                rawVal = qAns[0];
                            }

                            const strVal = String(rawVal).trim();

                            const textMatch = qOpts.find(o => normalizeText(o) === normalizeText(strVal));
                            if (textMatch) {
                                finalAnswer = textMatch;
                            }
                            else if (/^\d+$/.test(strVal)) {
                                const idx = parseInt(strVal);
                                if (idx >= 0 && idx < qOpts.length) {
                                    finalAnswer = qOpts[idx];
                                } else {
                                    finalAnswer = strVal; 
                                }
                            } else {
                                finalAnswer = strVal;
                            }

                            quizData[qSubject][qLevel].push({
                                question: qText.trim(),
                                options: qOpts,
                                answer: finalAnswer,
                                type: qType,
                                hint: qHint
                            });

                            count++;
                        }
                    });
                }

                saveQuizData();
                closeBulkUploader();
                alertMessage(`JSON Uploaded: ${count} questions!`, "bg-gradient-to-r from-green-500 to-teal-500");
                if (s) renderSubjectLevels(s);

            } catch (err) {
                console.error("JSON parse error:", err);
                alertMessage("Invalid JSON format", "bg-gradient-to-r from-red-500 to-pink-500");
            }
        };
        reader.readAsText(jsonFile);
        return;
    }

    // === CSV UPLOAD ===
    if (!file) return;
    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
            let count = 0;
            let lastSubject = '';

            res.data.forEach(row => {
                const qText = row.question || row.Question;
                const qAns = row.answer || row.Answer || row.correct;
                const qOptsStr = row.options || row.Options;
                const qSub = row.subject || row.Subject;
                const qLvl = row.level || row.Level;
                const qType = row.type || row.Type || 'radio';

                if (qText && qAns) {
                    const s = qSub || document.getElementById('uploadSubject').value;
                    const l = parseInt(qLvl || document.getElementById('uploadLevel').value);
                    lastSubject = s;

                    if (!quizData[s]) quizData[s] = {};
                    if (!quizData[s][l]) quizData[s][l] = [];

                    let opts;
                    if (qOptsStr) {
                        opts = qOptsStr.split('|').map(o => o.trim());
                    } else {
                        opts = [
                            String(qAns).trim(),
                            "Incorrect Option 1",
                            "Incorrect Option 2",
                            "Incorrect Option 3"
                        ];
                    }

                    let finalAnswer = String(qAns).trim();
                    
                    if (opts.includes(finalAnswer)) { 
                    }
                    else if (/^\d+$/.test(finalAnswer)) {
                        const idx = parseInt(finalAnswer) - 1;
                        if (idx >= 0 && idx < opts.length) {
                            finalAnswer = opts[idx];
                        }
                    }

                    quizData[s][l].push({
                        question: qText.trim(),
                        answer: finalAnswer,
                        options: opts,
                        type: qType,
                        hint: row.hint || ''
                    });

                    count++;
                }
            });

            saveQuizData();
            closeBulkUploader();
            alertMessage(`Uploaded ${count} questions`, "bg-gradient-to-r from-green-500 to-teal-500");
            if (lastSubject) renderSubjectLevels(lastSubject);
        },
        error: (err) => {
            console.error("CSV parse error:", err);
            alertMessage("Error parsing CSV file", "bg-gradient-to-r from-red-500 to-pink-500");
        }
    });
}

    function alertMessage(msg, bg) {
        const d = document.createElement('div');
        d.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-8 py-4 rounded-xl text-white font-bold shadow-2xl z-50 ${bg} text-sm`;
        d.textContent = msg;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 2500);
    }

    // ==== HELPER FUNCTION ====
    function openResourceWithTracking(id, name, subject, level) {
        window.lastExternalQuizContext = {
            subject: subject || currentSubject,
            level: level || currentLevel,
            resourceName: name
        };
        
        openResource(id);
    }
    
    // Exports
    window.handleSignIn = handleSignIn;
    window.handleSignUp = handleSignUp;
    window.renderAuthScreen = renderAuthScreen;
    window.renderSignUpForm = renderSignUpForm;
    window.renderWelcomeScreen = renderWelcomeScreen;
    window.renderStudentProfile = renderStudentProfile;
    window.renderSubjectLevels = renderSubjectLevels;
    window.startQuiz = startQuiz;
    window.selectAnswer = selectAnswer;
    window.nextQuestion = nextQuestion;
    window.prevQuestion = prevQuestion;
    window.renderAdminDashboard = renderAdminDashboard;
    window.checkAdminPassword = checkAdminPassword;
    window.closeModal = closeModal;
    window.openModal = openModal;
    window.openBulkUploader = openBulkUploader;
    window.closeBulkUploader = closeBulkUploader;
    window.processBulkUpload = processBulkUpload;
    window.openManualExamCreator = openManualExamCreator;
    window.closeManualExamCreator = closeManualExamCreator;
    window.addManualQuestion = addManualQuestion;
    window.saveManualExam = saveManualExam;
    window.openResourceUploader = openResourceUploader;
    window.closeResourceUploader = closeResourceUploader;
    window.saveResources = saveResources;
    window.openResource = openResource;
    window.openUrlResource = openUrlResource;
    window.openManualExamCreatorForSubject = openManualExamCreatorForSubject;
    window.openResourceUploaderForSubject = openResourceUploaderForSubject;
    window.updateTimerSettings = updateTimerSettings;
    window.toggleTimer = toggleTimer;
    window.deleteUser = deleteUser;
    window.scrollToUserList = scrollToUserList;
    window.changeManualType = changeManualType;
    window.addManualOptionInput = addManualOptionInput;
    window.updateManualOption = updateManualOption;
    window.showQuestionSummary = showQuestionSummary;
    window.updateManualAnswer = updateManualAnswer;
    window.updateManualMultiAnswer = updateManualMultiAnswer;
    window.toggleMultiSelect = toggleMultiSelect;
    window.submitMultiAnswer = submitMultiAnswer;
    window.renameResource = renameResource;
    window.deleteResource = deleteResource;
    window.openResourceWithTracking = openResourceWithTracking;
    window.openResetQuizModal = openResetQuizModal;
    window.closeResetModal = closeResetModal;
    window.confirmResetQuizProgress = confirmResetQuizProgress;
    window.openGlobalMenu = openGlobalMenu;
    window.openSubjectManagement = openSubjectManagement;
    window.closeSubjectManagement = closeSubjectManagement;
    window.addNewSubject = addNewSubject;
    window.renameSubject = renameSubject;
    window.deleteSubject = deleteSubject;
    window.editSubjectName = editSubjectName;
    window.saveSubjectChanges = saveSubjectChanges;
    window.openSubjectManagementFromUploader = openSubjectManagementFromUploader;
    window.openSubjectManagementFromManual = openSubjectManagementFromManual;
    window.openSubjectManagementFromResource = openSubjectManagementFromResource;
    window.showSubjectSummary = showSubjectSummary;
    window.editExam = editExam;
    window.deleteExam = deleteExam;
    window.openUrlManager = openUrlManager;
    window.updateUrlInput = updateUrlInput;
    window.addMoreUrlInput = addMoreUrlInput;
    window.removeUrlInput = removeUrlInput;
    window.renameUrlResource = renameUrlResource;
    window.deleteUrlResource = deleteUrlResource;
    window.toggleModalExpand = toggleModalExpand;
    window.openLevelMenu = openLevelMenu;
    window.editLevelSettings = editLevelSettings;
    window.deleteLevel = deleteLevel;
    window.openLevelRenameModal = openLevelRenameModal;
    window.closeLevelRenameModal = closeLevelRenameModal;
    window.saveLevelRename = saveLevelRename;
    window.handleSignOut = handleSignOut;
    window.toggleAccordion = toggleAccordion;
  </script>
</body>
</html>